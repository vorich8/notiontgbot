// MenuManager.cs
using Microsoft.Extensions.Logging;
using TeamManagerBot.Keyboards;
using TeamManagerBot.Models;
using TeamManagerBot.Services;
using Telegram.Bot;
using Telegram.Bot.Exceptions;
using Telegram.Bot.Types;
using Telegram.Bot.Types.ReplyMarkups;

namespace TeamManagerBot.Handlers
{
    public class MenuManager
    {
        private readonly ITelegramBotClient _botClient;
        private readonly ILogger<MenuManager> _logger;
        private readonly IUserService _userService;
        private readonly MenuStateManager _stateManager;
        private readonly Dictionary<long, DateTime> _lastMessageTime = new();

        public MenuManager(
            ITelegramBotClient botClient,
            ILogger<MenuManager> logger,
            IUserService userService,
            MenuStateManager stateManager)
        {
            _botClient = botClient;
            _logger = logger;
            _userService = userService;
            _stateManager = stateManager;
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/–æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–Ω—é
        public async Task<Message> ShowMainMenuAsync(long chatId, long userId, bool isAdmin, CancellationToken cancellationToken)
        {
            var text = $"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {(isAdmin ? "üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : "üë§ –£—á–∞—Å—Ç–Ω–∏–∫")}!\n\n" +
                      $"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.";

            var keyboard = MainMenuKeyboard.GetMainMenu(isAdmin);
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "main", cancellationToken);
        }

        public async Task<Message> ShowInlineMenuAsync(
            long chatId,
            string text,
            InlineKeyboardMarkup keyboard,
            string menuType,
            CancellationToken cancellationToken,
            bool forceNew = false)
        {
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, menuType, cancellationToken, forceNew);
        }

        #region –ú–µ—Ç–æ–¥—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –º–µ–Ω—é
        public async Task<Message> ShowProjectsMenuAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üìÇ –ú–æ–¥—É–ª—å –ø—Ä–æ–µ–∫—Ç–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:";
            var keyboard = MainMenuKeyboard.GetProjectsMenu();
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "projects", cancellationToken);
        }

        public async Task<Message> ShowTasksMenuAsync(long chatId, bool isAdmin, CancellationToken cancellationToken)
        {
            var text = "‚úÖ –ú–æ–¥—É–ª—å –∑–∞–¥–∞—á\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:";
            var keyboard = MainMenuKeyboard.GetTasksMenu(isAdmin);
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "tasks", cancellationToken);
        }

        public async Task<Message> ShowStatusesMenuAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üìä –ú–æ–¥—É–ª—å —Å—Ç–∞—Ç—É—Å–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:";
            var keyboard = MainMenuKeyboard.GetStatusesMenu();
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "statuses", cancellationToken);
        }

        public async Task<Message> ShowAdvertisementMenuAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üì¢ –ú–æ–¥—É–ª—å —Ä–µ–∫–ª–∞–º—ã\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:";
            var keyboard = MainMenuKeyboard.GetAdvertisementMenu();
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "advertisement", cancellationToken);
        }

        public async Task<Message> ShowContactsMenuAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:";
            var keyboard = MainMenuKeyboard.GetContactsMenu();
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "contacts", cancellationToken);
        }

        public async Task<Message> ShowDatabaseMenuAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üóÉÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥—ã\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:";
            var keyboard = MainMenuKeyboard.GetDatabaseMenu();
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "database", cancellationToken);
        }

        public async Task<Message> ShowFinanceMenuAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üí∞ –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è –∫–æ–º–∞–Ω–¥—ã\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:";
            var keyboard = MainMenuKeyboard.GetFinanceMenu();
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "finance", cancellationToken);
        }

        public async Task<Message> ShowKPIMenuAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üìà –ú–æ–¥—É–ª—å KPI\n\n–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á–µ—Ç:";
            var keyboard = MainMenuKeyboard.GetKPIMenu();
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "kpi", cancellationToken);
        }

        public async Task<Message> ShowSettingsMenuAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:";
            var keyboard = MainMenuKeyboard.GetSettingsMenu();
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "settings", cancellationToken);
        }
        #endregion

        #region –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        public async Task<Message> ShowProjectDetailsAsync(long chatId, Project project, CancellationToken cancellationToken)
        {
            var statusIcon = project.Status switch
            {
                ProjectStatus.Pending => "üü° –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç",
                ProjectStatus.InProgress => "üü† –í —Ä–∞–±–æ—Ç–µ",
                ProjectStatus.Completed => "‚úÖ –ì–æ—Ç–æ–≤–æ",
                _ => "‚ö™ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
            };

            var tasks = project.Tasks?.ToList() ?? new List<TeamTask>();
            var activeTasks = tasks.Count(t => t.Status == TeamTaskStatus.Active);
            var completedTasks = tasks.Count(t => t.Status == TeamTaskStatus.Completed);

            var text = $"üìÇ –ü—Ä–æ–µ–∫—Ç: {project.Name}\n\n" +
                      $"–û–ø–∏—Å–∞–Ω–∏–µ: {project.Description ?? "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}\n" +
                      $"–°—Ç–∞—Ç—É—Å: {statusIcon}\n" +
                      $"–ó–∞–¥–∞—á–∏: {activeTasks} –∞–∫—Ç–∏–≤–Ω—ã—Ö, {completedTasks} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ\n" +
                      $"–°–æ–∑–¥–∞–ª: @{project.CreatedBy?.Username ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}\n" +
                      $"–î–∞—Ç–∞: {project.CreatedAt:dd.MM.yyyy}";

            if (!string.IsNullOrEmpty(project.Link))
                text += $"\n–°—Å—ã–ª–∫–∞: {project.Link}";

            var keyboard = MainMenuKeyboard.GetProjectActions(project.Id);
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, $"project_{project.Id}", cancellationToken);
        }

        public async Task<Message> ShowTaskDetailsAsync(long chatId, TeamTask task, CancellationToken cancellationToken)
        {
            var statusText = task.Status switch
            {
                TeamTaskStatus.Active => "üü¢ –ê–∫—Ç–∏–≤–Ω–∞",      // ‚Üê –ò–ó–ú–ï–ù–ò–õ–û–°–¨
                TeamTaskStatus.Completed => "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞",  // ‚Üê –ò–ó–ú–ï–ù–ò–õ–û–°–¨
                TeamTaskStatus.Archived => "üìÅ –í –∞—Ä—Ö–∏–≤–µ",   // ‚Üê –ò–ó–ú–ï–ù–ò–õ–û–°–¨
                _ => "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
            };

            var text = $"üìã –ó–∞–¥–∞—á–∞: {task.Title}\n\n" +
                      $"–û–ø–∏—Å–∞–Ω–∏–µ: {task.Description ?? "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}\n" +
                      $"–°—Ç–∞—Ç—É—Å: {statusText}\n" +
                      $"–ü—Ä–æ–µ–∫—Ç: {task.Project?.Name ?? "–ù–µ —É–∫–∞–∑–∞–Ω"}\n" +
                      $"–ù–∞–∑–Ω–∞—á–µ–Ω–∞: @{task.AssignedTo?.Username ?? "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞"}\n" +
                      $"–°–æ–∑–¥–∞–ª: @{task.CreatedBy?.Username ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}\n" +
                      $"–°–æ–∑–¥–∞–Ω–∞: {task.CreatedAt:dd.MM.yyyy}";

            if (task.DueDate.HasValue)
            {
                var dueDate = task.DueDate.Value;
                var daysLeft = (dueDate.Date - DateTime.UtcNow.Date).Days;
                text += $"\n–°—Ä–æ–∫: {dueDate:dd.MM.yyyy}";

                if (daysLeft < 0 && task.Status == TeamTaskStatus.Active)
                    text += " ‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞!";
                else if (daysLeft <= 3 && task.Status == TeamTaskStatus.Active)
                    text += $" ‚è∞ –û—Å—Ç–∞–ª–æ—Å—å {daysLeft} –¥–Ω.";
            }

            var buttons = new List<List<InlineKeyboardButton>>();

            if (task.Status == TeamTaskStatus.Active)
            {
                buttons.Add(new List<InlineKeyboardButton>
                {
                    InlineKeyboardButton.WithCallbackData("‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å", $"{CallbackData.TaskCompletePrefix}{task.Id}")
                });
            }
            else if (task.Status == TeamTaskStatus.Completed)
            {
                buttons.Add(new List<InlineKeyboardButton>
                {
                    InlineKeyboardButton.WithCallbackData("üîÑ –í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É", $"task_reactivate_{task.Id}")
                });
            }

            buttons.Add(new List<InlineKeyboardButton>
            {
                InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToTasks)
            });

            var keyboard = new InlineKeyboardMarkup(buttons);
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, $"task_{task.Id}", cancellationToken);
        }

        public async Task<Message> ShowDeleteConfirmationAsync(
            long chatId,
            string entityName,
            string entityDescription,
            string confirmCallback,
            string cancelCallback,
            CancellationToken cancellationToken)
        {
            var text = $"‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è\n\n" +
                      $"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å {entityName}?\n\n" +
                      $"{entityDescription}\n\n" +
                      $"‚ùó –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å!";

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new()
                {
                    InlineKeyboardButton.WithCallbackData("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", confirmCallback),
                    InlineKeyboardButton.WithCallbackData("‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∞", cancelCallback)
                }
            };

            var keyboard = new InlineKeyboardMarkup(buttons);
            return await UpdateOrSendMenuAsync(chatId, text, keyboard, "delete_confirmation", cancellationToken, true);
        }

        public async Task<Message> ShowContactsListAsync(long chatId, List<TeamContact> contacts, CancellationToken cancellationToken)
        {
            if (contacts.Count == 0)
            {
                return await ShowInlineMenuAsync(
                    chatId,
                    "üì≠ –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—É—Å—Ç.\n\n–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç!",
                    new InlineKeyboardMarkup(new[]
                    {
                        new[]
                        {
                            InlineKeyboardButton.WithCallbackData("‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç", CallbackData.ContactsAdd),
                            InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToContacts)
                        }
                    }),
                    "contacts_list_empty",
                    cancellationToken);
            }

            var text = $"üë• –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ ({contacts.Count}):\n\n";
            var buttons = new List<List<InlineKeyboardButton>>();

            foreach (var contact in contacts.Take(15))
            {
                var displayName = !string.IsNullOrEmpty(contact.FullName)
                    ? $"{contact.FullName} (@{contact.TelegramUsername})"
                    : $"@{contact.TelegramUsername}";

                buttons.Add(new List<InlineKeyboardButton>
                {
                    InlineKeyboardButton.WithCallbackData(
                        $"üë§ {displayName}",
                        $"contact_{contact.Id}")
                });
            }

            if (contacts.Count > 15)
            {
                text += $"\n... –∏ –µ—â–µ {contacts.Count - 15} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤";
            }

            buttons.Add(new List<InlineKeyboardButton>
            {
                InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToContacts)
            });

            return await ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "contacts_list",
                cancellationToken);
        }

        public async Task<Message> ShowContactDetailsAsync(long chatId, TeamContact contact, CancellationToken cancellationToken)
        {
            var text = $"üë§ –ö–æ–Ω—Ç–∞–∫—Ç\n\n" +
                      $"Username: @{contact.TelegramUsername}\n";

            if (!string.IsNullOrEmpty(contact.FullName))
                text += $"–ò–º—è: {contact.FullName}\n";

            if (!string.IsNullOrEmpty(contact.Nickname))
                text += $"–ü—Å–µ–≤–¥–æ–Ω–∏–º: {contact.Nickname}\n";

            if (!string.IsNullOrEmpty(contact.ContactType))
                text += $"–¢–∏–ø: {contact.ContactType}\n";

            if (!string.IsNullOrEmpty(contact.Tags))
                text += $"–¢–µ–≥–∏: {contact.Tags}\n";

            text += $"\n–î–æ–±–∞–≤–ª–µ–Ω: {contact.CreatedAt:dd.MM.yyyy}";

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", $"contact_edit_{contact.Id}") },
                new() { InlineKeyboardButton.WithCallbackData("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", $"contact_delete_{contact.Id}") },
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToContacts) }
            };

            return await ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                $"contact_{contact.Id}",
                cancellationToken);
        }
        #endregion

        #region –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        private async Task<Message> UpdateOrSendMenuAsync(
            long chatId,
            string text,
            ReplyMarkup keyboard,
            string menuType,
            CancellationToken cancellationToken,
            bool forceNew = false)
        {
            try
            {
                Message message;
                var now = DateTime.UtcNow;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (!forceNew && _stateManager.TryGetMenuMessage(chatId, out int messageId, out string currentMenuType))
                {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ —Å–µ–∫—É–Ω–¥—É)
                    if (_lastMessageTime.TryGetValue(chatId, out DateTime lastTime))
                    {
                        var timeSinceLast = now - lastTime;
                        if (timeSinceLast.TotalSeconds < 1)
                        {
                            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                            await Task.Delay(1000 - (int)timeSinceLast.TotalMilliseconds, cancellationToken);
                        }
                    }

                    try
                    {
                        if (keyboard is InlineKeyboardMarkup inlineKeyboard)
                        {
                            // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å inline-–º–µ–Ω—é
                            message = await _botClient.EditMessageText(
                                chatId: chatId,
                                messageId: messageId,
                                text: text,
                                replyMarkup: inlineKeyboard,
                                cancellationToken: cancellationToken);

                            _stateManager.SetMenuMessage(chatId, message.MessageId, menuType);
                        }
                        else
                        {
                            // –î–ª—è reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
                            await _botClient.DeleteMessage(chatId, messageId, cancellationToken);

                            message = await _botClient.SendMessage(
                                chatId: chatId,
                                text: text,
                                replyMarkup: keyboard,
                                cancellationToken: cancellationToken);

                            _stateManager.SetMenuMessage(chatId, message.MessageId, menuType);
                        }
                    }
                    catch (ApiRequestException ex) when (
                        ex.Message.Contains("message to edit not found") ||
                        ex.Message.Contains("message is not modified") ||
                        ex.Message.Contains("message can't be edited") ||
                        ex.ErrorCode == 400)
                    {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        _logger.LogDebug("Could not edit message, sending new one: {Error}", ex.Message);

                        // –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        try { await _botClient.DeleteMessage(chatId, messageId, cancellationToken); }
                        catch { /* –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */ }

                        message = await SendNewMessageAsync(chatId, text, keyboard, cancellationToken);
                        _stateManager.SetMenuMessage(chatId, message.MessageId, menuType);
                    }
                    catch (Exception ex)
                    {
                        _logger.LogWarning(ex, "Error editing message, sending new one");
                        message = await SendNewMessageAsync(chatId, text, keyboard, cancellationToken);
                        _stateManager.SetMenuMessage(chatId, message.MessageId, menuType);
                    }
                }
                else
                {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    message = await SendNewMessageAsync(chatId, text, keyboard, cancellationToken);
                    _stateManager.SetMenuMessage(chatId, message.MessageId, menuType);
                }

                _lastMessageTime[chatId] = now;
                return message;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in UpdateOrSendMenuAsync for chat {ChatId}, menu type: {MenuType}",
                    chatId, menuType);

                // –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                try
                {
                    var message = await SendNewMessageAsync(chatId, text, keyboard, cancellationToken);
                    _stateManager.SetMenuMessage(chatId, message.MessageId, menuType);
                    return message;
                }
                catch (Exception recoveryEx)
                {
                    _logger.LogError(recoveryEx, "Failed to recover menu for chat {ChatId}", chatId);
                    throw;
                }
            }
        }

        private async Task<Message> SendNewMessageAsync(
            long chatId,
            string text,
            ReplyMarkup keyboard,
            CancellationToken cancellationToken)
        {
            try
            {
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–µ–Ω—é –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (_stateManager.TryGetMenuMessage(chatId, out int oldMessageId, out _))
                {
                    try
                    {
                        await _botClient.DeleteMessage(chatId, oldMessageId, cancellationToken);
                    }
                    catch (Exception ex)
                    {
                        _logger.LogDebug(ex, "Could not delete old message {MessageId} in chat {ChatId}",
                            oldMessageId, chatId);
                    }
                }

                return await _botClient.SendMessage(
                    chatId: chatId,
                    text: text,
                    replyMarkup: keyboard,
                    cancellationToken: cancellationToken);
            }
            catch (ApiRequestException ex) when (ex.Message.Contains("bot was blocked by the user"))
            {
                _logger.LogWarning("Bot was blocked by user in chat {ChatId}", chatId);
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending new message to chat {ChatId}", chatId);
                throw;
            }
        }

        public async Task SendTemporaryMessageAsync(long chatId, string text, CancellationToken cancellationToken, int deleteAfterSeconds = 5)
        {
            try
            {
                var message = await _botClient.SendMessage(
                    chatId: chatId,
                    text: text,
                    cancellationToken: cancellationToken);

                // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                if (deleteAfterSeconds > 0)
                {
                    _ = Task.Run(async () =>
                    {
                        try
                        {
                            await Task.Delay(deleteAfterSeconds * 1000, cancellationToken);
                            await _botClient.DeleteMessage(chatId, message.MessageId, cancellationToken);
                        }
                        catch (Exception ex)
                        {
                            _logger.LogDebug(ex, "Could not delete temporary message in chat {ChatId}", chatId);
                        }
                    }, cancellationToken);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending temporary message to chat {ChatId}", chatId);
            }
        }

        public async Task SendTemporaryInlineMessageAsync(
            long chatId,
            string text,
            InlineKeyboardMarkup keyboard,
            CancellationToken cancellationToken,
            int deleteAfterSeconds = 30)
        {
            try
            {
                var message = await _botClient.SendMessage(
                    chatId: chatId,
                    text: text,
                    replyMarkup: keyboard,
                    cancellationToken: cancellationToken);

                // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                if (deleteAfterSeconds > 0)
                {
                    _ = Task.Run(async () =>
                    {
                        try
                        {
                            await Task.Delay(deleteAfterSeconds * 1000, cancellationToken);
                            await _botClient.DeleteMessage(chatId, message.MessageId, cancellationToken);
                        }
                        catch (Exception ex)
                        {
                            _logger.LogDebug(ex, "Could not delete temporary message in chat {ChatId}", chatId);
                        }
                    }, cancellationToken);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending temporary inline message to chat {ChatId}", chatId);
            }
        }

        public void ClearMenuState(long chatId)
        {
            _stateManager.ClearMenu(chatId);
            _lastMessageTime.Remove(chatId);
        }

        public bool TryGetCurrentMenu(long chatId, out string menuType)
        {
            if (_stateManager.TryGetMenuMessage(chatId, out _, out menuType))
            {
                return true;
            }

            menuType = string.Empty;
            return false;
        }

        public async Task CleanupOldMessagesAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                // –ù–∞–ø—Ä–∏–º–µ—Ä, —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞—Ä—à–µ N —á–∞—Å–æ–≤
                ClearMenuState(chatId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error cleaning up old messages for chat {ChatId}", chatId);
            }
        }
        #endregion
    }
}
