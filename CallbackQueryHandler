// CallbackQueryHandler.cs 
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using TeamManagerBot.Keyboards;
using TeamManagerBot.Models;
using TeamManagerBot.Services;
using Telegram.Bot;
using Telegram.Bot.Types;
using Telegram.Bot.Types.ReplyMarkups;

namespace TeamManagerBot.Handlers
{
    public class CallbackQueryHandler
    {
        private readonly ITelegramBotClient _botClient;
        private readonly IUserService _userService;
        private readonly IProjectService _projectService;
        private readonly ITaskService _taskService;
        private readonly IFinanceService _financeService;
        private readonly IContactService _contactService;
        private readonly ILogger<CallbackQueryHandler> _logger;
        private readonly Dictionary<long, UserState> _userStates = new();
        private readonly IServiceProvider _serviceProvider;
        private readonly MenuManager _menuManager;

        public CallbackQueryHandler(
            ITelegramBotClient botClient,
            IUserService userService,
            IProjectService projectService,
            ITaskService taskService,
            IFinanceService financeService,
            IContactService contactService,
            ILogger<CallbackQueryHandler> logger,
            IServiceProvider serviceProvider,
            MenuManager menuManager)
        {
            _botClient = botClient;
            _userService = userService;
            _projectService = projectService;
            _taskService = taskService;
            _financeService = financeService;
            _contactService = contactService;
            _logger = logger;
            _serviceProvider = serviceProvider;
            _menuManager = menuManager;
        }

        public async Task<bool> HandleMessageAsync(Message message, CancellationToken cancellationToken)
        {
            var userId = message.From!.Id;
            var chatId = message.Chat.Id;
            var text = message.Text ?? string.Empty;

            if (_userStates.TryGetValue(userId, out var state))
            {
                await HandleUserStateAsync(chatId, userId, text, state, cancellationToken);
                _userStates.Remove(userId);
                return true;
            }

            return false;
        }

        public async Task HandleCallbackQueryAsync(CallbackQuery callbackQuery, CancellationToken cancellationToken)
        {
            if (callbackQuery.Data == null || callbackQuery.Message == null)
                return;

            var chatId = callbackQuery.Message.Chat.Id;
            var userId = callbackQuery.From.Id;
            var callbackData = callbackQuery.Data;

            try
            {
                await _botClient.AnswerCallbackQuery(callbackQuery.Id, cancellationToken: cancellationToken);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await _userService.UpdateUserLastActiveAsync(userId);

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø callback
                if (callbackData.StartsWith(CallbackData.ProjectPrefix))
                {
                    await HandleProjectCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
                else if (callbackData.StartsWith(CallbackData.TaskPrefix))
                {
                    await HandleTaskCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
                else if (callbackData.StartsWith("finance_"))
                {
                    await HandleFinanceCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
                else if (callbackData.StartsWith("kpi_"))
                {
                    await HandleKpiCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
                else if (callbackData.StartsWith("contacts_"))
                {
                    await HandleContactsCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
                else if (callbackData.StartsWith("settings_"))
                {
                    await HandleSettingsCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
                else if (callbackData.StartsWith("status_"))
                {
                    await HandleStatusCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
                else if (callbackData.StartsWith("ad_"))
                {
                    await HandleAdvertisementCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
                else if (callbackData.StartsWith("database_"))
                {
                    await HandleDatabaseCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
                else
                {
                    await HandleNavigationCallbackAsync(chatId, userId, callbackData, cancellationToken);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error handling callback query: {CallbackData}", callbackData);
                await SendTemporaryMessageAsync(chatId, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.", cancellationToken);
            }
        }

        #region –ü—Ä–æ–µ–∫—Ç—ã - –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleProjectCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case CallbackData.CreateProject:
                    _userStates[userId] = new UserState
                    {
                        CurrentAction = UserActions.CreateProject,
                        Step = 1
                    };
                    await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:", cancellationToken);
                    break;

                case CallbackData.ProjectsList:
                    await ShowProjectsListAsync(chatId, cancellationToken);
                    break;

                default:
                    if (callbackData.StartsWith(CallbackData.ProjectPrefix))
                    {
                        var projectIdStr = callbackData.Replace(CallbackData.ProjectPrefix, "");
                        if (int.TryParse(projectIdStr, out int projectId))
                        {
                            await ShowProjectDetailsAsync(chatId, projectId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith(CallbackData.EditProjectPrefix))
                    {
                        var projectIdStr = callbackData.Replace(CallbackData.EditProjectPrefix, "");
                        if (int.TryParse(projectIdStr, out int projectId))
                        {
                            _userStates[userId] = new UserState
                            {
                                CurrentAction = UserActions.EditProject,
                                ProjectId = projectId,
                                Step = 1
                            };
                            await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:", cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith(CallbackData.DeleteProjectPrefix))
                    {
                        var projectIdStr = callbackData.Replace(CallbackData.DeleteProjectPrefix, "");
                        if (int.TryParse(projectIdStr, out int projectId))
                        {
                            await ShowDeleteProjectConfirmationAsync(chatId, projectId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith(CallbackData.DeleteConfirmPrefix))
                    {
                        var projectIdStr = callbackData.Replace(CallbackData.DeleteConfirmPrefix, "");
                        if (int.TryParse(projectIdStr, out int projectId))
                        {
                            await DeleteProjectAsync(chatId, projectId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith(CallbackData.DeleteCancelPrefix))
                    {
                        var projectIdStr = callbackData.Replace(CallbackData.DeleteCancelPrefix, "");
                        if (int.TryParse(projectIdStr, out int projectId))
                        {
                            await ShowProjectDetailsAsync(chatId, projectId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith(CallbackData.ChangeStatusPrefix))
                    {
                        var projectIdStr = callbackData.Replace(CallbackData.ChangeStatusPrefix, "");
                        if (int.TryParse(projectIdStr, out int projectId))
                        {
                            await ShowProjectStatusChangeMenuAsync(chatId, projectId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith(CallbackData.StatusPendingPrefix) ||
                             callbackData.StartsWith(CallbackData.StatusInProgressPrefix) ||
                             callbackData.StartsWith(CallbackData.StatusCompletedPrefix))
                    {
                        var parts = callbackData.Split('_');
                        if (parts.Length >= 3 && int.TryParse(parts[^1], out int projectId))
                        {
                            var status = parts[1] switch
                            {
                                "pending" => ProjectStatus.Pending,
                                "inprogress" => ProjectStatus.InProgress,
                                "completed" => ProjectStatus.Completed,
                                _ => ProjectStatus.Pending
                            };

                            await UpdateProjectStatusAsync(chatId, projectId, status, cancellationToken);
                        }
                    }
                    break;
            }
        }

        private async Task ShowProjectsListAsync(long chatId, CancellationToken cancellationToken)
        {
            var projects = await _projectService.GetAllProjectsAsync();

            if (projects.Count == 0)
            {
                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    "üì≠ –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø—É—Å—Ç.\n\n–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç!",
                    new InlineKeyboardMarkup(new[]
                    {
                        new[]
                        {
                            InlineKeyboardButton.WithCallbackData("‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç", CallbackData.CreateProject),
                            InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToProjects)
                        }
                    }),
                    "projects_list",
                    cancellationToken);
                return;
            }

            var text = "üìã –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:";
            var buttons = new List<List<InlineKeyboardButton>>();

            foreach (var project in projects.Take(10))
            {
                var statusIcon = project.Status switch
                {
                    ProjectStatus.Pending => "üü°",
                    ProjectStatus.InProgress => "üü†",
                    ProjectStatus.Completed => "‚úÖ",
                    _ => "‚ö™"
                };

                buttons.Add(new List<InlineKeyboardButton>
                {
                    InlineKeyboardButton.WithCallbackData(
                        $"{statusIcon} {project.Name}",
                        $"{CallbackData.ProjectPrefix}{project.Id}")
                });
            }

            buttons.Add(new List<InlineKeyboardButton>
            {
                InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToProjects)
            });

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "projects_list",
                cancellationToken);
        }

        private async Task ShowProjectDetailsAsync(long chatId, int projectId, CancellationToken cancellationToken)
        {
            var project = await _projectService.GetProjectAsync(projectId);
            if (project == null)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", cancellationToken);
                await _menuManager.ShowProjectsMenuAsync(chatId, cancellationToken);
                return;
            }

            var statusIcon = project.Status switch
            {
                ProjectStatus.Pending => "üü° –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç",
                ProjectStatus.InProgress => "üü† –í —Ä–∞–±–æ—Ç–µ",
                ProjectStatus.Completed => "‚úÖ –ì–æ—Ç–æ–≤–æ",
                _ => "‚ö™ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
            };

            var tasks = project.Tasks?.ToList() ?? new List<TeamTask>();
            var activeTasks = tasks.Count(t => t.Status == TeamTaskStatus.Active);
            var completedTasks = tasks.Count(t => t.Status == TeamTaskStatus.Completed);

            var text = $"üìÇ –ü—Ä–æ–µ–∫—Ç: {project.Name}\n\n" +
                      $"–û–ø–∏—Å–∞–Ω–∏–µ: {project.Description ?? "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}\n" +
                      $"–°—Ç–∞—Ç—É—Å: {statusIcon}\n" +
                      $"–ó–∞–¥–∞—á–∏: {activeTasks} –∞–∫—Ç–∏–≤–Ω—ã—Ö, {completedTasks} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ\n" +
                      $"–°–æ–∑–¥–∞–ª: @{project.CreatedBy?.Username ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}\n" +
                      $"–î–∞—Ç–∞: {project.CreatedAt:dd.MM.yyyy}";

            if (!string.IsNullOrEmpty(project.Link))
                text += $"\n–°—Å—ã–ª–∫–∞: {project.Link}";

            var keyboard = MainMenuKeyboard.GetProjectActions(project.Id);
            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                keyboard,
                $"project_{project.Id}",
                cancellationToken);
        }

        private async Task ShowDeleteProjectConfirmationAsync(long chatId, int projectId, CancellationToken cancellationToken)
        {
            var project = await _projectService.GetProjectAsync(projectId);
            if (project == null)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", cancellationToken);
                return;
            }

            await _menuManager.ShowDeleteConfirmationAsync(
                chatId,
                "–ø—Ä–æ–µ–∫—Ç",
                $"–ù–∞–∑–≤–∞–Ω–∏–µ: {project.Name}\n–û–ø–∏—Å–∞–Ω–∏–µ: {project.Description ?? "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}",
                $"{CallbackData.DeleteConfirmPrefix}{projectId}",
                $"{CallbackData.ProjectPrefix}{projectId}",
                cancellationToken);
        }

        private async Task DeleteProjectAsync(long chatId, int projectId, CancellationToken cancellationToken)
        {
            var success = await _projectService.DeleteProjectAsync(projectId);
            if (success)
            {
                await SendTemporaryMessageAsync(chatId, "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.", cancellationToken);
                await _menuManager.ShowProjectsMenuAsync(chatId, cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç.", cancellationToken);
            }
        }

        private async Task ShowProjectStatusChangeMenuAsync(long chatId, int projectId, CancellationToken cancellationToken)
        {
            var text = "üìä –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:";
            var keyboard = MainMenuKeyboard.GetProjectStatusChange(projectId);

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                keyboard,
                $"change_status_{projectId}",
                cancellationToken);
        }

        private async Task UpdateProjectStatusAsync(long chatId, int projectId, ProjectStatus status, CancellationToken cancellationToken)
        {
            var success = await _projectService.UpdateProjectStatusAsync(projectId, status);
            if (success)
            {
                var statusText = status switch
                {
                    ProjectStatus.Pending => "üü° –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç",
                    ProjectStatus.InProgress => "üü† –í —Ä–∞–±–æ—Ç–µ",
                    ProjectStatus.Completed => "‚úÖ –ì–æ—Ç–æ–≤–æ",
                    _ => "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                };

                await SendTemporaryMessageAsync(chatId, $"‚úÖ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞: {statusText}", cancellationToken);
                await ShowProjectDetailsAsync(chatId, projectId, cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞.", cancellationToken);
            }
        }
        #endregion

        #region –ó–∞–¥–∞—á–∏ - –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleTaskCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case CallbackData.TasksCreate:
                    await ShowProjectSelectionForTaskAsync(chatId, userId, cancellationToken);
                    break;

                case CallbackData.TasksList:
                    await ShowAllTasksAsync(chatId, cancellationToken);
                    break;

                case CallbackData.TasksMy:
                    await ShowMyTasksAsync(chatId, userId, cancellationToken);
                    break;

                case CallbackData.TasksArchive:
                    await ShowArchivedTasksAsync(chatId, cancellationToken);
                    break;

                default:
                    if (callbackData.StartsWith(CallbackData.TaskPrefix))
                    {
                        var taskIdStr = callbackData.Replace(CallbackData.TaskPrefix, "");
                        if (int.TryParse(taskIdStr, out int taskId))
                        {
                            await ShowTaskDetailsAsync(chatId, taskId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith(CallbackData.TaskCompletePrefix))
                    {
                        var taskIdStr = callbackData.Replace(CallbackData.TaskCompletePrefix, "");
                        if (int.TryParse(taskIdStr, out int taskId))
                        {
                            await CompleteTaskAsync(chatId, taskId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("task_reactivate_"))
                    {
                        var taskIdStr = callbackData.Replace("task_reactivate_", "");
                        if (int.TryParse(taskIdStr, out int taskId))
                        {
                            await ReactivateTaskAsync(chatId, taskId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("task_archive_"))
                    {
                        var taskIdStr = callbackData.Replace("task_archive_", "");
                        if (int.TryParse(taskIdStr, out int taskId))
                        {
                            await ArchiveTaskAsync(chatId, taskId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("project_for_task_"))
                    {
                        var projectIdStr = callbackData.Replace("project_for_task_", "");
                        if (int.TryParse(projectIdStr, out int projectId))
                        {
                            _userStates[userId] = new UserState
                            {
                                CurrentAction = UserActions.CreateTask,
                                ProjectId = projectId,
                                Step = 1
                            };
                            await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:", cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("task_delete_"))
                    {
                        var taskIdStr = callbackData.Replace("task_delete_", "");
                        if (int.TryParse(taskIdStr, out int taskId))
                        {
                            await ShowDeleteTaskConfirmationAsync(chatId, taskId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("task_delete_confirm_"))
                    {
                        var taskIdStr = callbackData.Replace("task_delete_confirm_", "");
                        if (int.TryParse(taskIdStr, out int taskId))
                        {
                            await DeleteTaskAsync(chatId, taskId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("task_delete_cancel_"))
                    {
                        var taskIdStr = callbackData.Replace("task_delete_cancel_", "");
                        if (int.TryParse(taskIdStr, out int taskId))
                        {
                            await ShowTaskDetailsAsync(chatId, taskId, cancellationToken);
                        }
                    }
                    break;
            }
        }

        private async Task ShowProjectSelectionForTaskAsync(long chatId, long userId, CancellationToken cancellationToken)
        {
            var projects = await _projectService.GetAllProjectsAsync();

            if (projects.Count == 0)
            {
                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    "üì≠ –ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏.\n\n–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç!",
                    new InlineKeyboardMarkup(new[]
                    {
                        new[]
                        {
                            InlineKeyboardButton.WithCallbackData("‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç", CallbackData.CreateProject),
                            InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToTasks)
                        }
                    }),
                    "task_project_selection",
                    cancellationToken);
                return;
            }

            var text = "üìù –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:";
            var buttons = new List<List<InlineKeyboardButton>>();

            foreach (var project in projects.Take(10))
            {
                buttons.Add(new List<InlineKeyboardButton>
                {
                    InlineKeyboardButton.WithCallbackData(project.Name, $"project_for_task_{project.Id}")
                });
            }

            buttons.Add(new List<InlineKeyboardButton>
            {
                InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToTasks)
            });

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "task_project_selection",
                cancellationToken);
        }

        private async Task ShowAllTasksAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º GetAllTasksAsync –≤–º–µ—Å—Ç–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–µ—Ç–æ–¥–∞
                var allTasks = await _taskService.GetAllTasksAsync();
                var activeTasks = allTasks.Where(t => t.Status == TeamTaskStatus.Active).Take(10).ToList();

                if (activeTasks.Count == 0)
                {
                    await _menuManager.ShowInlineMenuAsync(
                        chatId,
                        "üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á.",
                        new InlineKeyboardMarkup(new[]
                        {
                    new[]
                    {
                        InlineKeyboardButton.WithCallbackData("‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É", CallbackData.TasksCreate),
                        InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToTasks)
                    }
                        }),
                        "tasks_list",
                        cancellationToken);
                    return;
                }

                var text = "üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:\n\n";
                var buttons = new List<List<InlineKeyboardButton>>();

                foreach (var task in activeTasks)
                {
                    var dueText = task.DueDate.HasValue ? $" (–¥–æ {task.DueDate.Value:dd.MM.yyyy})" : "";
                    text += $"üü¢ {task.Title}{dueText}\n";

                    buttons.Add(new List<InlineKeyboardButton>
            {
                InlineKeyboardButton.WithCallbackData(
                    $"üü¢ {task.Title}",
                    $"{CallbackData.TaskPrefix}{task.Id}")
            });
                }

                buttons.Add(new List<InlineKeyboardButton>
        {
            InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToTasks)
        });

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "tasks_list",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing all tasks");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á.", cancellationToken);
            }
        }

        private async Task ShowMyTasksAsync(long chatId, long userId, CancellationToken cancellationToken)
        {
            try
            {
                var tasks = await _taskService.GetTasksByUserAsync(userId);
                var activeTasks = tasks.Where(t => t.Status == TeamTaskStatus.Active).Take(5).ToList();
                var completedTasks = tasks.Where(t => t.Status == TeamTaskStatus.Completed).Take(3).ToList();

                var text = "üìã –í–∞—à–∏ –∑–∞–¥–∞—á–∏:\n\n";

                if (activeTasks.Count > 0)
                {
                    text += "üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ:\n";
                    foreach (var task in activeTasks)
                    {
                        text += $"‚Ä¢ {task.Title}";
                        if (task.DueDate.HasValue)
                            text += $" (–¥–æ {task.DueDate.Value:dd.MM.yyyy})";
                        text += "\n";
                    }
                }

                if (completedTasks.Count > 0)
                {
                    text += "\n‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ:\n";
                    foreach (var task in completedTasks)
                    {
                        text += $"‚Ä¢ {task.Title}\n";
                    }
                }

                if (activeTasks.Count == 0 && completedTasks.Count == 0)
                {
                    text += "üì≠ –£ –≤–∞—Å –Ω–µ—Ç –∑–∞–¥–∞—á.";
                }

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É", CallbackData.TasksCreate) },
            new() { InlineKeyboardButton.WithCallbackData("üìã –í—Å–µ –∑–∞–¥–∞—á–∏", CallbackData.TasksList) },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToTasks) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "my_tasks",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing my tasks");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∞—à–∏—Ö –∑–∞–¥–∞—á.", cancellationToken);
            }
        }

        private async Task ShowArchivedTasksAsync(long chatId, CancellationToken cancellationToken)
        {
            var tasks = await _taskService.GetAllTasksAsync();
            var archivedTasks = tasks.Where(t => t.Status == TeamTaskStatus.Archived).Take(10).ToList();

            if (archivedTasks.Count == 0)
            {
                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    "üì≠ –ù–µ—Ç –∑–∞–¥–∞—á –≤ –∞—Ä—Ö–∏–≤–µ.",
                    new InlineKeyboardMarkup(new[]
                    {
                        new[]
                        {
                            InlineKeyboardButton.WithCallbackData("üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏", CallbackData.TasksList),
                            InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToTasks)
                        }
                    }),
                    "tasks_archive",
                    cancellationToken);
                return;
            }

            var text = "üìÅ –ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á:\n\n";
            var buttons = new List<List<InlineKeyboardButton>>();

            foreach (var task in archivedTasks)
            {
                text += $"üìÅ {task.Title}\n";
                buttons.Add(new List<InlineKeyboardButton>
                {
                    InlineKeyboardButton.WithCallbackData(
                        $"üìÅ {task.Title}",
                        $"{CallbackData.TaskPrefix}{task.Id}")
                });
            }

            buttons.Add(new List<InlineKeyboardButton>
            {
                InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToTasks)
            });

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "tasks_archive",
                cancellationToken);
        }

        private async Task ShowTaskDetailsAsync(long chatId, int taskId, CancellationToken cancellationToken)
        {
            var task = await _taskService.GetTaskAsync(taskId);
            if (task == null)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", cancellationToken);
                return;
            }

            var statusText = task.Status switch
            {
                TeamTaskStatus.Active => "üü¢ –ê–∫—Ç–∏–≤–Ω–∞",
                TeamTaskStatus.Completed => "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞",
                TeamTaskStatus.Archived => "üìÅ –í –∞—Ä—Ö–∏–≤–µ",
                _ => "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
            };

            var text = $"üìã –ó–∞–¥–∞—á–∞: {task.Title}\n\n" +
                      $"–û–ø–∏—Å–∞–Ω–∏–µ: {task.Description ?? "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}\n" +
                      $"–°—Ç–∞—Ç—É—Å: {statusText}\n" +
                      $"–ü—Ä–æ–µ–∫—Ç: {task.Project?.Name ?? "–ù–µ —É–∫–∞–∑–∞–Ω"}\n" +
                      $"–ù–∞–∑–Ω–∞—á–µ–Ω–∞: @{task.AssignedTo?.Username ?? "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞"}\n" +
                      $"–°–æ–∑–¥–∞–Ω–∞: {task.CreatedAt:dd.MM.yyyy}";

            if (task.DueDate.HasValue)
            {
                var dueDate = task.DueDate.Value;
                var daysLeft = (dueDate.Date - DateTime.UtcNow.Date).Days;
                text += $"\n–°—Ä–æ–∫: {dueDate:dd.MM.yyyy}";

                if (daysLeft < 0 && task.Status == TeamTaskStatus.Active)
                    text += " ‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞!";
                else if (daysLeft <= 3 && task.Status == TeamTaskStatus.Active)
                    text += $" ‚è∞ –û—Å—Ç–∞–ª–æ—Å—å {daysLeft} –¥–Ω.";
            }

            var buttons = new List<List<InlineKeyboardButton>>();

            if (task.Status == TeamTaskStatus.Active)
            {
                buttons.Add(new List<InlineKeyboardButton>
                {
                    InlineKeyboardButton.WithCallbackData("‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å", $"{CallbackData.TaskCompletePrefix}{task.Id}"),
                    InlineKeyboardButton.WithCallbackData("üìÅ –í –∞—Ä—Ö–∏–≤", $"task_archive_{task.Id}")
                });
            }
            else if (task.Status == TeamTaskStatus.Completed)
            {
                buttons.Add(new List<InlineKeyboardButton>
                {
                    InlineKeyboardButton.WithCallbackData("üîÑ –í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É", $"task_reactivate_{task.Id}"),
                    InlineKeyboardButton.WithCallbackData("üìÅ –í –∞—Ä—Ö–∏–≤", $"task_archive_{task.Id}")
                });
            }
            else if (task.Status == TeamTaskStatus.Archived)
            {
                buttons.Add(new List<InlineKeyboardButton>
                {
                    InlineKeyboardButton.WithCallbackData("üîÑ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å", $"task_reactivate_{task.Id}")
                });
            }

            buttons.Add(new List<InlineKeyboardButton>
            {
                InlineKeyboardButton.WithCallbackData("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", $"task_delete_{task.Id}"),
                InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToTasks)
            });

            var keyboard = new InlineKeyboardMarkup(buttons);
            await _menuManager.ShowInlineMenuAsync(chatId, text, keyboard, $"task_{task.Id}", cancellationToken);
        }

        private async Task CompleteTaskAsync(long chatId, int taskId, CancellationToken cancellationToken)
        {
            var success = await _taskService.CompleteTaskAsync(taskId);
            if (success)
            {
                await SendTemporaryMessageAsync(chatId, "‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!", cancellationToken);
                await ShowTaskDetailsAsync(chatId, taskId, cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É.", cancellationToken);
            }
        }

        private async Task ReactivateTaskAsync(long chatId, int taskId, CancellationToken cancellationToken)
        {
            var success = await _taskService.ActivateTaskAsync(taskId);
            if (success)
            {
                await SendTemporaryMessageAsync(chatId, "‚úÖ –ó–∞–¥–∞—á–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É!", cancellationToken);
                await ShowTaskDetailsAsync(chatId, taskId, cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É.", cancellationToken);
            }
        }

        private async Task ArchiveTaskAsync(long chatId, int taskId, CancellationToken cancellationToken)
        {
            var success = await _taskService.ArchiveTaskAsync(taskId);
            if (success)
            {
                await SendTemporaryMessageAsync(chatId, "‚úÖ –ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤!", cancellationToken);
                await ShowTaskDetailsAsync(chatId, taskId, cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É.", cancellationToken);
            }
        }

        private async Task ShowDeleteTaskConfirmationAsync(long chatId, int taskId, CancellationToken cancellationToken)
        {
            var task = await _taskService.GetTaskAsync(taskId);
            if (task == null)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.", cancellationToken);
                return;
            }

            await _menuManager.ShowDeleteConfirmationAsync(
                chatId,
                "–∑–∞–¥–∞—á—É",
                $"–ù–∞–∑–≤–∞–Ω–∏–µ: {task.Title}\n–û–ø–∏—Å–∞–Ω–∏–µ: {task.Description ?? "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}",
                $"task_delete_confirm_{taskId}",
                $"{CallbackData.TaskPrefix}{taskId}",
                cancellationToken);
        }

        private async Task DeleteTaskAsync(long chatId, int taskId, CancellationToken cancellationToken)
        {
            var success = await _taskService.DeleteTaskAsync(taskId);
            if (success)
            {
                await SendTemporaryMessageAsync(chatId, "‚úÖ –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.", cancellationToken);
                await _menuManager.ShowTasksMenuAsync(chatId, await _userService.IsAdminAsync(0), cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É.", cancellationToken);
            }
        }
        #endregion

        #region –§–∏–Ω–∞–Ω—Å—ã - –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleFinanceCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case CallbackData.FinanceDeposit:
                    await ShowDepositInfoAsync(chatId, cancellationToken);
                    break;

                case CallbackData.FinanceIncomes:
                    await ShowIncomesAsync(chatId, cancellationToken);
                    break;

                case CallbackData.FinanceExpenses:
                    await ShowExpensesAsync(chatId, cancellationToken);
                    break;

                case CallbackData.FinanceAddIncome:
                    await ShowIncomeCategoriesAsync(chatId, userId, cancellationToken);
                    break;

                case CallbackData.FinanceAddExpense:
                    await ShowExpenseCategoriesAsync(chatId, userId, cancellationToken);
                    break;

                case CallbackData.FinanceStats:
                    await ShowFinanceStatisticsAsync(chatId, cancellationToken);
                    break;

                case CallbackData.FinanceCommission:
                    await ShowCommissionInfoAsync(chatId, cancellationToken);
                    break;

                case CallbackData.FinanceInvestments:
                    await ShowInvestmentsInfoAsync(chatId, cancellationToken);
                    break;

                case CallbackData.FinanceCrypto:
                    await ShowCryptoInfoAsync(chatId, cancellationToken);
                    break;

                case CallbackData.FinanceFi:
                    await ShowFastInvestInfoAsync(chatId, cancellationToken);
                    break;

                case CallbackData.FinanceCategories:
                    await ShowFinanceCategoriesMenuAsync(chatId, cancellationToken);
                    break;

                default:
                    if (callbackData.StartsWith("income_category_"))
                    {
                        var category = callbackData.Replace("income_category_", "");
                        _userStates[userId] = new UserState
                        {
                            CurrentAction = UserActions.AddIncome,
                            Data = new Dictionary<string, object?> { ["category"] = category },
                            Step = 1
                        };
                        await SendTemporaryMessageAsync(chatId, $"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏—è: {category}):", cancellationToken);
                    }
                    else if (callbackData.StartsWith("expense_category_"))
                    {
                        var category = callbackData.Replace("expense_category_", "");
                        _userStates[userId] = new UserState
                        {
                            CurrentAction = UserActions.AddExpense,
                            Data = new Dictionary<string, object?> { ["category"] = category },
                            Step = 1
                        };
                        await SendTemporaryMessageAsync(chatId, $"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏—è: {category}):", cancellationToken);
                    }
                    else if (callbackData.StartsWith("finance_deposit_"))
                    {
                        await HandleDepositActionAsync(chatId, userId, callbackData, cancellationToken);
                    }
                    else if (callbackData.StartsWith("finance_incomes_"))
                    {
                        await HandleIncomesActionAsync(chatId, callbackData, cancellationToken);
                    }
                    else if (callbackData.StartsWith("finance_expenses_"))
                    {
                        await HandleExpensesActionAsync(chatId, callbackData, cancellationToken);
                    }
                    else if (callbackData.StartsWith("finance_stats_"))
                    {
                        await HandleStatsActionAsync(chatId, callbackData, cancellationToken);
                    }
                    break;
            }
        }

        private async Task ShowDepositInfoAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var depositRecords = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Deposit);
                var totalDeposit = depositRecords.Sum(r => r.Amount);

                var withdrawalRecords = await _financeService.GetRecordsByCategoryAsync("–í—ã–≤–æ–¥");
                var totalWithdrawal = withdrawalRecords.Sum(r => r.Amount);

                var available = totalDeposit - totalWithdrawal;

                var text = "üíµ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ–ø–æ–∑–∏—Ç–µ\n\n" +
                          $"–û–±—â–∏–π –¥–µ–ø–æ–∑–∏—Ç: {totalDeposit:N2} USD\n" +
                          $"–î–æ—Å—Ç—É–ø–Ω–æ: {available:N2} USD\n\n" +
                          "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:\n";

                var lastRecords = depositRecords.Take(5).Concat(withdrawalRecords.Take(3))
                    .OrderByDescending(r => r.TransactionDate)
                    .Take(5);

                foreach (var record in lastRecords)
                {
                    var sign = record.Type == FinancialRecordType.Deposit ? "+" : "-";
                    var date = record.TransactionDate.ToString("dd.MM.yyyy");
                    text += $"‚Ä¢ {date}: {sign}{record.Amount:N2} USD ({record.Description})\n";
                }

                var buttons = new List<List<InlineKeyboardButton>>
                {
                    new() { InlineKeyboardButton.WithCallbackData("‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "finance_deposit_add") },
                    new() { InlineKeyboardButton.WithCallbackData("‚ûñ –í—ã–≤–µ—Å—Ç–∏", "finance_deposit_withdraw") },
                    new() { InlineKeyboardButton.WithCallbackData("üìä –ò—Å—Ç–æ—Ä–∏—è", "finance_deposit_history") },
                    new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToFinance) }
                };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "finance_deposit",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing deposit info");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ.", cancellationToken);
            }
        }

        private async Task ShowIncomesAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var monthStart = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
                var weekStart = DateTime.UtcNow.AddDays(-7);

                var monthlyIncome = await _financeService.GetTotalIncomeAsync(monthStart, DateTime.UtcNow);
                var weeklyIncome = await _financeService.GetTotalIncomeAsync(weekStart, DateTime.UtcNow);

                var text = $"üí∞ –î–æ—Ö–æ–¥—ã\n\n" +
                          $"üíµ –ó–∞ –º–µ—Å—è—Ü: {monthlyIncome:N2} USD\n" +
                          $"üìà –ó–∞ –Ω–µ–¥–µ–ª—é: {weeklyIncome:N2} USD\n\n" +
                          $"–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n";

                var incomeByCategory = await _financeService.GetIncomeByCategoryAsync(monthStart, DateTime.UtcNow);
                foreach (var category in incomeByCategory.Take(5))
                {
                    text += $"‚Ä¢ {category.Category}: {category.Total:N2} USD\n";
                }

                var buttons = new List<List<InlineKeyboardButton>>
                {
                    new() { InlineKeyboardButton.WithCallbackData("‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥", CallbackData.FinanceAddIncome) },
                    new() { InlineKeyboardButton.WithCallbackData("üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è", "finance_incomes_details") },
                    new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –ø–µ—Ä–∏–æ–¥", "finance_incomes_period") },
                    new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToFinance) }
                };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "finance_incomes",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing incomes");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ—Ö–æ–¥–∞—Ö.", cancellationToken);
            }
        }

        private async Task ShowExpensesAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var monthStart = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
                var weekStart = DateTime.UtcNow.AddDays(-7);

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ GetTotalExpensesAsync —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–∞—Ç
                var monthlyExpenses = await _financeService.GetTotalExpensesAsync(monthStart, DateTime.UtcNow);
                var weeklyExpenses = await _financeService.GetTotalExpensesAsync(weekStart, DateTime.UtcNow);

                // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
                var expensesByCategory = await _financeService.GetExpensesByCategoryAsync(monthStart, DateTime.UtcNow);

                var text = $"üí∏ –†–∞—Å—Ö–æ–¥—ã\n\n" +
                          $"üìâ –ó–∞ –º–µ—Å—è—Ü: {monthlyExpenses:N2} USD\n" +
                          $"üìä –ó–∞ –Ω–µ–¥–µ–ª—é: {weeklyExpenses:N2} USD\n\n" +
                          $"–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n";

                foreach (var category in expensesByCategory.Take(5))
                {
                    var percentage = monthlyExpenses > 0 ? category.Total / monthlyExpenses * 100 : 0;
                    text += $"‚Ä¢ {category.Category}: {category.Total:N2} USD ({percentage:F1}%)\n";
                }

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥", CallbackData.FinanceAddExpense) },
            new() { InlineKeyboardButton.WithCallbackData("üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è", "finance_expenses_details") },
            new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –ø–µ—Ä–∏–æ–¥", "finance_expenses_period") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToFinance) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "finance_expenses",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing expenses");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö.", cancellationToken);
            }
        }

        public async Task ShowFinanceStatisticsAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var statistics = await _financeService.GetFinanceStatisticsAsync();

                var text = $"üìä –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n" +
                          $"üí∞ –û–±—â–∏–π –¥–æ—Ö–æ–¥: {statistics.TotalIncome:N2} USD\n" +
                          $"üí∏ –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: {statistics.TotalExpenses:N2} USD\n" +
                          $"‚öñÔ∏è –ë–∞–ª–∞–Ω—Å: {statistics.Balance:N2} USD\n\n" +
                          $"üìà –î–æ—Ö–æ–¥—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: {statistics.MonthlyIncome:N2} USD\n" +
                          $"üìâ –†–∞—Å—Ö–æ–¥—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: {statistics.MonthlyExpenses:N2} USD\n\n" +
                          $"üèÜ –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ—Ö–æ–¥–æ–≤:\n";

                foreach (var category in statistics.IncomeByCategory.Take(3))
                {
                    var percentage = statistics.MonthlyIncome > 0 ? category.Total / statistics.MonthlyIncome * 100 : 0;
                    text += $"‚Ä¢ {category.Category}: {category.Total:N2} USD ({percentage:F1}%)\n";
                }

                text += $"\nüí∏ –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤:\n";
                foreach (var category in statistics.ExpensesByCategory.Take(3))
                {
                    var percentage = statistics.MonthlyExpenses > 0 ? category.Total / statistics.MonthlyExpenses * 100 : 0;
                    text += $"‚Ä¢ {category.Category}: {category.Total:N2} USD ({percentage:F1}%)\n";
                }

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –º–µ—Å—è—Ü", "finance_stats_month") },
            new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –∫–≤–∞—Ä—Ç–∞–ª", "finance_stats_quarter") },
            new() { InlineKeyboardButton.WithCallbackData("üìä –ì—Ä–∞—Ñ–∏–∫–∏", "finance_stats_charts") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToFinance) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "finance_statistics",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing finance statistics");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.", cancellationToken);
            }
        }

        private async Task ShowIncomeCategoriesAsync(long chatId, long userId, CancellationToken cancellationToken)
        {
            await _menuManager.ShowInlineMenuAsync(
                chatId,
                "üí∞ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–æ—Ö–æ–¥–∞:",
                MainMenuKeyboard.GetIncomeCategories(),
                "income_categories",
                cancellationToken);
        }

        private async Task ShowExpenseCategoriesAsync(long chatId, long userId, CancellationToken cancellationToken)
        {
            await _menuManager.ShowInlineMenuAsync(
                chatId,
                "üí∏ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ä–∞—Å—Ö–æ–¥–∞:",
                MainMenuKeyboard.GetExpenseCategories(),
                "expense_categories",
                cancellationToken);
        }

        private async Task ShowCommissionInfoAsync(long chatId, CancellationToken cancellationToken)
        {
            var commissionRecords = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Commission);
            var totalCommission = commissionRecords.Sum(r => r.Amount);
            var monthlyCommission = commissionRecords
                .Where(r => r.TransactionDate.Month == DateTime.UtcNow.Month)
                .Sum(r => r.Amount);

            var text = $"üìä –ö–æ–º–∏—Å—Å–∏–∏\n\n" +
                      $"–û–±—â–∞—è –∫–æ–º–∏—Å—Å–∏—è: {totalCommission:N2} USD\n" +
                      $"–ó–∞ –º–µ—Å—è—Ü: {monthlyCommission:N2} USD\n\n" +
                      $"–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n" +
                      $"‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ BNB –¥–ª—è –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–π\n" +
                      $"‚Ä¢ –û–±—ä–µ–¥–∏–Ω—è–π—Ç–µ –æ—Ä–¥–µ—Ä–∞";

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –ø–µ—Ä–∏–æ–¥", "finance_commission_period") },
                new() { InlineKeyboardButton.WithCallbackData("üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è", "finance_commission_details") },
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToFinance) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "finance_commission",
                cancellationToken);
        }

        private async Task ShowInvestmentsInfoAsync(long chatId, CancellationToken cancellationToken)
        {
            var investmentRecords = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Investment);
            var totalInvestment = investmentRecords.Sum(r => r.Amount);

            var text = $"üë• –í–∫–ª–∞–¥—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n\n" +
                      $"–û–±—â–∞—è —Å—É–º–º–∞ –≤–∫–ª–∞–¥–æ–≤: {totalInvestment:N2} USD\n\n" +
                      $"–£—á–∞—Å—Ç–Ω–∏–∫–∏:\n";

            var byUser = investmentRecords.GroupBy(r => r.User?.Username ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
            foreach (var group in byUser.OrderByDescending(g => g.Sum(r => r.Amount)).Take(5))
            {
                var userTotal = group.Sum(r => r.Amount);
                var percentage = totalInvestment > 0 ? userTotal / totalInvestment * 100 : 0;
                text += $"‚Ä¢ @{group.Key}: {userTotal:N2} USD ({percentage:F1}%)\n";
            }

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥", "finance_investment_add") },
                new() { InlineKeyboardButton.WithCallbackData("‚ûñ –í—ã–≤–µ—Å—Ç–∏ –¥–æ–ª—é", "finance_investment_withdraw") },
                new() { InlineKeyboardButton.WithCallbackData("üìä –ò—Å—Ç–æ—Ä–∏—è", "finance_investment_history") },
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToFinance) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "finance_investments",
                cancellationToken);
        }

        private async Task ShowCryptoInfoAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üí∏ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã\n\n" +
                      "–û–±—â–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—å: 15,000 USD\n\n" +
                      "–ê–∫—Ç–∏–≤—ã:\n" +
                      "‚Ä¢ BTC: 8,000 USD (53.3%)\n" +
                      "‚Ä¢ ETH: 4,000 USD (26.7%)\n" +
                      "‚Ä¢ SOL: 2,000 USD (13.3%)\n" +
                      "‚Ä¢ USDT: 1,000 USD (6.7%)\n\n" +
                      "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ 24—á: +3.2%";

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("üìà –ì—Ä–∞—Ñ–∏–∫–∏", "finance_crypto_charts") },
                new() { InlineKeyboardButton.WithCallbackData("üí∞ –ë–∞–ª–∞–Ω—Å", "finance_crypto_balance") },
                new() { InlineKeyboardButton.WithCallbackData("üìä –ò—Å—Ç–æ—Ä–∏—è", "finance_crypto_history") },
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToFinance) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "finance_crypto",
                cancellationToken);
        }

        private async Task ShowFastInvestInfoAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üè¶ Fast Invest (–§–ò)\n\n" +
                      "–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 3,250 USD\n" +
                      "–î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü: +325 USD (+10%)\n\n" +
                      "–ê–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏:\n" +
                      "‚Ä¢ –ó–∞–µ–º #12345: 1,000 USD (12% –≥–æ–¥–æ–≤—ã—Ö)\n" +
                      "‚Ä¢ –ó–∞–µ–º #12346: 750 USD (10% –≥–æ–¥–æ–≤—ã—Ö)\n" +
                      "‚Ä¢ –ó–∞–µ–º #12347: 500 USD (8% –≥–æ–¥–æ–≤—ã—Ö)\n\n" +
                      "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n" +
                      "‚Ä¢ –î–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏\n" +
                      "‚Ä¢ –†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏–±—ã–ª—å";

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("‚ûï –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å", "finance_fi_invest") },
                new() { InlineKeyboardButton.WithCallbackData("üí∞ –ë–∞–ª–∞–Ω—Å", "finance_fi_balance") },
                new() { InlineKeyboardButton.WithCallbackData("üìä –ò—Å—Ç–æ—Ä–∏—è", "finance_fi_history") },
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToFinance) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "finance_fi",
                cancellationToken);
        }

        private async Task ShowFinanceCategoriesMenuAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n\n" +
                      "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤.\n\n" +
                      "–î–æ—Ö–æ–¥—ã:\n" +
                      "‚Ä¢ –ü—Ä–æ–¥–∞–∂–∏\n" +
                      "‚Ä¢ –ü–∞—Ä—Ç–Ω–µ—Ä–∫–∏\n" +
                      "‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏\n" +
                      "‚Ä¢ –§—Ä–∏–ª–∞–Ω—Å\n" +
                      "‚Ä¢ –¢—Ä–µ–π–¥–∏–Ω–≥\n" +
                      "‚Ä¢ –ü—Ä–æ—á–µ–µ\n\n" +
                      "–†–∞—Å—Ö–æ–¥—ã:\n" +
                      "‚Ä¢ –ê—Ä–µ–Ω–¥–∞\n" +
                      "‚Ä¢ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n" +
                      "‚Ä¢ –°–æ—Ñ—Ç\n" +
                      "‚Ä¢ –†–µ–∫–ª–∞–º–∞\n" +
                      "‚Ä¢ –ó–∞—Ä–ø–ª–∞—Ç—ã\n" +
                      "‚Ä¢ –ü—Ä–æ—á–µ–µ";

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é", "finance_category_add") },
                new() { InlineKeyboardButton.WithCallbackData("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", "finance_category_edit") },
                new() { InlineKeyboardButton.WithCallbackData("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", "finance_category_delete") },
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToFinance) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "finance_categories",
                cancellationToken);
        }

        private async Task HandleDepositActionAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case "finance_deposit_add":
                    _userStates[userId] = new UserState
                    {
                        CurrentAction = "add_deposit",
                        Step = 1
                    };
                    await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (USD):", cancellationToken);
                    break;

                case "finance_deposit_withdraw":
                    _userStates[userId] = new UserState
                    {
                        CurrentAction = "withdraw_deposit",
                        Step = 1
                    };
                    await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤—ã–≤–æ–¥–∞ (USD):", cancellationToken);
                    break;

                case "finance_deposit_history":
                    await ShowDepositHistoryAsync(chatId, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.", cancellationToken);
                    break;
            }
        }

        private async Task HandleIncomesActionAsync(long chatId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case "finance_incomes_details":
                    await ShowDetailedIncomesAsync(chatId, cancellationToken);
                    break;

                case "finance_incomes_period":
                    await ShowIncomesPeriodSelectionAsync(chatId, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.", cancellationToken);
                    break;
            }
        }

        private async Task HandleExpensesActionAsync(long chatId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case "finance_expenses_details":
                    await ShowDetailedExpensesAsync(chatId, cancellationToken);
                    break;

                case "finance_expenses_period":
                    await ShowExpensesPeriodSelectionAsync(chatId, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.", cancellationToken);
                    break;
            }
        }

        private async Task HandleStatsActionAsync(long chatId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case "finance_stats_month":
                    var monthStart = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
                    await ShowFinanceStatisticsForPeriodAsync(chatId, monthStart, DateTime.UtcNow, "–º–µ—Å—è—Ü", cancellationToken);
                    break;

                case "finance_stats_quarter":
                    var quarterStart = new DateTime(DateTime.UtcNow.Year, ((DateTime.UtcNow.Month - 1) / 3) * 3 + 1, 1);
                    await ShowFinanceStatisticsForPeriodAsync(chatId, quarterStart, DateTime.UtcNow, "–∫–≤–∞—Ä—Ç–∞–ª", cancellationToken);
                    break;

                case "finance_stats_charts":
                    await ShowFinanceChartsAsync(chatId, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.", cancellationToken);
                    break;
            }
        }

        private async Task ShowDepositHistoryAsync(long chatId, CancellationToken cancellationToken)
        {
            var depositRecords = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Deposit);
            var withdrawalRecords = await _financeService.GetRecordsByCategoryAsync("–í—ã–≤–æ–¥");

            var allRecords = depositRecords.Concat(withdrawalRecords)
                .OrderByDescending(r => r.TransactionDate)
                .Take(20)
                .ToList();

            var text = "üìä –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –¥–µ–ø–æ–∑–∏—Ç—É\n\n";

            if (allRecords.Count == 0)
            {
                text += "üì≠ –û–ø–µ—Ä–∞—Ü–∏–π –Ω–µ—Ç.\n";
            }
            else
            {
                foreach (var record in allRecords)
                {
                    var sign = record.Type == FinancialRecordType.Deposit ? "+" : "-";
                    var date = record.TransactionDate.ToString("dd.MM.yyyy");
                    var type = record.Type == FinancialRecordType.Deposit ? "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ" : "–í—ã–≤–æ–¥";
                    text += $"‚Ä¢ {date}: {sign}{record.Amount:N2} USD - {type} ({record.Description})\n";
                }
            }

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.FinanceDeposit) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "deposit_history",
                cancellationToken);
        }

        private async Task ShowDetailedIncomesAsync(long chatId, CancellationToken cancellationToken)
        {
            var monthStart = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
            var incomes = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Income);
            var monthlyIncomes = incomes.Where(i => i.TransactionDate >= monthStart).ToList();

            var text = $"üí∞ –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Ö–æ–¥–æ–≤ ({monthStart:MMMM yyyy})\n\n";

            if (monthlyIncomes.Count == 0)
            {
                text += "üì≠ –î–æ—Ö–æ–¥–æ–≤ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –Ω–µ—Ç.\n";
            }
            else
            {
                var total = monthlyIncomes.Sum(i => i.Amount);
                text += $"üìä –í—Å–µ–≥–æ: {total:N2} USD\n\n";

                var byCategory = monthlyIncomes.GroupBy(i => i.Category);
                foreach (var group in byCategory.OrderByDescending(g => g.Sum(i => i.Amount)))
                {
                    var categoryTotal = group.Sum(i => i.Amount);
                    var percentage = total > 0 ? categoryTotal / total * 100 : 0;
                    text += $"üè∑Ô∏è {group.Key}: {categoryTotal:N2} USD ({percentage:F1}%)\n";
                }
            }

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.FinanceIncomes) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "incomes_details",
                cancellationToken);
        }

        private async Task ShowIncomesPeriodSelectionAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üìÖ –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è –¥–æ—Ö–æ–¥–æ–≤\n\n" +
                      "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Ö–æ–¥–æ–≤:";

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é", "incomes_period_week") },
                new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –º–µ—Å—è—Ü", "incomes_period_month") },
                new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –∫–≤–∞—Ä—Ç–∞–ª", "incomes_period_quarter") },
                new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –≥–æ–¥", "incomes_period_year") },
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.FinanceIncomes) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "incomes_period",
                cancellationToken);
        }

        private async Task ShowDetailedExpensesAsync(long chatId, CancellationToken cancellationToken)
        {
            var monthStart = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
            var expenses = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Expense);
            var monthlyExpenses = expenses.Where(e => e.TransactionDate >= monthStart).ToList();

            var text = $"üí∏ –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ ({monthStart:MMMM yyyy})\n\n";

            if (monthlyExpenses.Count == 0)
            {
                text += "üì≠ –†–∞—Å—Ö–æ–¥–æ–≤ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –Ω–µ—Ç.\n";
            }
            else
            {
                var total = monthlyExpenses.Sum(e => e.Amount);
                text += $"üìä –í—Å–µ–≥–æ: {total:N2} USD\n\n";

                var byCategory = monthlyExpenses.GroupBy(e => e.Category);
                foreach (var group in byCategory.OrderByDescending(g => g.Sum(e => e.Amount)))
                {
                    var categoryTotal = group.Sum(e => e.Amount);
                    var percentage = total > 0 ? categoryTotal / total * 100 : 0;
                    text += $"üè∑Ô∏è {group.Key}: {categoryTotal:N2} USD ({percentage:F1}%)\n";
                }
            }

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.FinanceExpenses) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "expenses_details",
                cancellationToken);
        }

        private async Task ShowExpensesPeriodSelectionAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üìÖ –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤\n\n" +
                      "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤:";

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é", "expenses_period_week") },
                new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –º–µ—Å—è—Ü", "expenses_period_month") },
                new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –∫–≤–∞—Ä—Ç–∞–ª", "expenses_period_quarter") },
                new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –≥–æ–¥", "expenses_period_year") },
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.FinanceExpenses) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "expenses_period",
                cancellationToken);
        }

        private async Task ShowFinanceStatisticsForPeriodAsync(long chatId, DateTime startDate, DateTime endDate, string periodName, CancellationToken cancellationToken)
        {
            var statistics = await _financeService.GetFinanceStatisticsAsync(startDate, endDate);

            var text = $"üìä –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ {periodName}\n\n" +
                      $"üìÖ –ü–µ—Ä–∏–æ–¥: {startDate:dd.MM.yyyy} - {endDate:dd.MM.yyyy}\n\n" +
                      $"üí∞ –î–æ—Ö–æ–¥: {statistics.TotalIncome:N2} USD\n" +
                      $"üí∏ –†–∞—Å—Ö–æ–¥: {statistics.TotalExpenses:N2} USD\n" +
                      $"‚öñÔ∏è –ë–∞–ª–∞–Ω—Å: {statistics.Balance:N2} USD\n" +
                      $"üìà –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å: {(statistics.TotalIncome > 0 ? statistics.Balance / statistics.TotalIncome * 100 : 0):F1}%\n\n" +
                      $"üèÜ –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ—Ö–æ–¥–æ–≤:\n";

            foreach (var category in statistics.IncomeByCategory.Take(3))
            {
                var percentage = statistics.TotalIncome > 0 ? category.Total / statistics.TotalIncome * 100 : 0;
                text += $"‚Ä¢ {category.Category}: {category.Total:N2} USD ({percentage:F1}%)\n";
            }

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.FinanceStats) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                $"finance_stats_{periodName}",
                cancellationToken);
        }

        private async Task ShowFinanceChartsAsync(long chatId, CancellationToken cancellationToken)
        {
            var text = "üìà –ì—Ä–∞—Ñ–∏–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ KPI\n\n" +
                      "–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏:\n\n" +
                      "üìä 1. –î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤\n" +
                      "   ‚Ä¢ –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –ø–æ –º–µ—Å—è—Ü–∞–º\n" +
                      "   ‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ—Ä–∏–æ–¥–æ–º\n\n" +
                      "üìä 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ—Ö–æ–¥–æ–≤\n" +
                      "   ‚Ä¢ –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n" +
                      "   ‚Ä¢ –î–æ–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n\n" +
                      "üìä 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤\n" +
                      "   ‚Ä¢ –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n" +
                      "   ‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç\n\n" +
                      "üìä 4. –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü\n" +
                      "   ‚Ä¢ –¢—Ä–µ–Ω–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö\n" +
                      "   ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏";

            var buttons = new List<List<InlineKeyboardButton>>
            {
                new() { InlineKeyboardButton.WithCallbackData("üìà –î–∏–Ω–∞–º–∏–∫–∞", "charts_trend") },
                new() { InlineKeyboardButton.WithCallbackData("ü•ß –î–æ—Ö–æ–¥—ã", "charts_income") },
                new() { InlineKeyboardButton.WithCallbackData("ü•ß –†–∞—Å—Ö–æ–¥—ã", "charts_expenses") },
                new() { InlineKeyboardButton.WithCallbackData("üîÆ –ü—Ä–æ–≥–Ω–æ–∑", "charts_forecast") },
                new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.FinanceStats) }
            };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "finance_charts",
                cancellationToken);
        }
        #endregion

        #region –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleUserStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            switch (state.CurrentAction)
            {
                case UserActions.CreateProject:
                    await HandleCreateProjectStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                case UserActions.EditProject:
                    await HandleEditProjectStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                case UserActions.CreateTask:
                    await HandleCreateTaskStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                case UserActions.AddIncome:
                    await HandleAddIncomeStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                case UserActions.AddExpense:
                    await HandleAddExpenseStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                case UserActions.AddContact:
                    await HandleAddContactStateAsync(chatId, userId, text, cancellationToken);
                    break;

                case UserActions.SearchContact:
                    await HandleSearchContactStateAsync(chatId, userId, text, cancellationToken);
                    break;

                case UserActions.WriteStatus:
                    await HandleWriteStatusStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                case "add_deposit":
                    await HandleAddDepositStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                case "withdraw_deposit":
                    await HandleWithdrawDepositStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                case "create_content_plan":
                    await HandleCreateContentPlanStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                case "create_campaign":
                    await HandleCreateCampaignStateAsync(chatId, userId, text, state, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.", cancellationToken);
                    break;
            }
        }

        private async Task HandleCreateProjectStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (string.IsNullOrWhiteSpace(text))
            {
                await SendTemporaryMessageAsync(chatId, "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.", cancellationToken);
                return;
            }

            if (state.Step == 1)
            {
                state.Data["name"] = text;
                state.Step = 2;
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ '-' —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):", cancellationToken);
            }
            else if (state.Step == 2)
            {
                var name = state.Data["name"]?.ToString() ?? "";
                var description = text == "-" ? null : text;

                var project = await _projectService.CreateProjectAsync(name, description, null, userId);
                if (project != null)
                {
                    await SendTemporaryMessageAsync(chatId, $"‚úÖ –ü—Ä–æ–µ–∫—Ç \"{project.Name}\" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!", cancellationToken);
                    await ShowProjectDetailsAsync(chatId, project.Id, cancellationToken);
                }
                else
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.", cancellationToken);
                }
            }
        }

        private async Task HandleEditProjectStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (!state.ProjectId.HasValue)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞: ID –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.", cancellationToken);
                return;
            }

            var project = await _projectService.GetProjectAsync(state.ProjectId.Value);
            if (project == null)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", cancellationToken);
                return;
            }

            project.Name = text;
            project.UpdatedAt = DateTime.UtcNow;

            var updateResult = await _projectService.UpdateProjectAsync(project);
            if (updateResult)
            {
                await SendTemporaryMessageAsync(chatId, $"‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞: {text}", cancellationToken);
                await ShowProjectDetailsAsync(chatId, state.ProjectId.Value, cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç.", cancellationToken);
            }
        }

        private async Task HandleCreateTaskStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (!state.ProjectId.HasValue)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞: –ø—Ä–æ–µ–∫—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω.", cancellationToken);
                return;
            }

            if (state.Step == 1)
            {
                state.Data["title"] = text;
                state.Step = 2;
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ '-' —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):", cancellationToken);
            }
            else if (state.Step == 2)
            {
                state.Data["description"] = text == "-" ? null : text;
                state.Step = 3;
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ '-' —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):", cancellationToken);
            }
            else if (state.Step == 3)
            {
                DateTime? dueDate = null;
                if (text != "-")
                {
                    if (DateTime.TryParseExact(text, "dd.MM.yyyy", null, System.Globalization.DateTimeStyles.None, out var parsedDate))
                    {
                        dueDate = parsedDate;
                    }
                    else
                    {
                        await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì", cancellationToken);
                        return;
                    }
                }

                var task = await _taskService.CreateTaskAsync(
                    title: state.Data["title"]?.ToString() ?? "",
                    description: state.Data["description"]?.ToString(),
                    projectId: state.ProjectId.Value,
                    assignedToUserId: userId,
                    createdByUserId: userId,
                    dueDate: dueDate);

                if (task != null)
                {
                    await SendTemporaryMessageAsync(chatId, $"‚úÖ –ó–∞–¥–∞—á–∞ \"{task.Title}\" —Å–æ–∑–¥–∞–Ω–∞!", cancellationToken);
                    await ShowTaskDetailsAsync(chatId, task.Id, cancellationToken);
                }
                else
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É.", cancellationToken);
                }
            }
        }

        private async Task HandleAddDepositStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (state.Step == 1)
            {
                if (!decimal.TryParse(text, out decimal amount) || amount <= 0)
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0):", cancellationToken);
                    return;
                }

                state.Data["amount"] = amount;
                state.Step = 2;
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—Ä—Ç–∞, –ö—Ä–∏–ø—Ç–∞ –∏ —Ç.–¥.):", cancellationToken);
            }
            else if (state.Step == 2)
            {
                var amount = (decimal)state.Data["amount"]!;

                var record = await _financeService.CreateFinancialRecordAsync(
                    type: FinancialRecordType.Deposit,
                    category: "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ",
                    description: text,
                    amount: amount,
                    currency: "USD",
                    source: text,
                    userId: userId,
                    projectId: null);

                if (record != null)
                {
                    await SendTemporaryMessageAsync(chatId,
                        $"‚úÖ –î–µ–ø–æ–∑–∏—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount:N2} USD!\n–ò—Å—Ç–æ—á–Ω–∏–∫: {text}",
                        cancellationToken);

                    await _menuManager.ShowFinanceMenuAsync(chatId, cancellationToken);
                }
                else
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ø–æ–ª–Ω–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç.", cancellationToken);
                }
            }
        }

        private async Task HandleWithdrawDepositStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (state.Step == 1)
            {
                if (!decimal.TryParse(text, out decimal amount) || amount <= 0)
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0):", cancellationToken);
                    return;
                }

                state.Data["amount"] = amount;
                state.Step = 2;
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –≤—ã–≤–æ–¥–∞:", cancellationToken);
            }
            else if (state.Step == 2)
            {
                var amount = (decimal)state.Data["amount"]!;

                var record = await _financeService.CreateFinancialRecordAsync(
                    type: FinancialRecordType.Expense,
                    category: "–í—ã–≤–æ–¥",
                    description: $"–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤: {text}",
                    amount: amount,
                    currency: "USD",
                    source: text,
                    userId: userId,
                    projectId: null);

                if (record != null)
                {
                    await SendTemporaryMessageAsync(chatId,
                        $"‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ {amount:N2} USD —Å–æ–∑–¥–∞–Ω–∞!\n–†–µ–∫–≤–∏–∑–∏—Ç—ã: {text}\n\n–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.",
                        cancellationToken);

                    await _menuManager.ShowFinanceMenuAsync(chatId, cancellationToken);
                }
                else
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥.", cancellationToken);
                }
            }
        }

        private async Task HandleAddContactStateAsync(long chatId, long userId, string text, CancellationToken cancellationToken)
        {
            if (string.IsNullOrWhiteSpace(text))
            {
                await SendTemporaryMessageAsync(chatId, "Username –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.", cancellationToken);
                return;
            }

            var contact = await _contactService.CreateSimpleContactAsync(text, contactType: "–î–æ–ø");
            if (contact != null)
            {
                await SendTemporaryMessageAsync(chatId, $"‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç @{contact.TelegramUsername} –¥–æ–±–∞–≤–ª–µ–Ω!", cancellationToken);
                await _menuManager.ShowContactsMenuAsync(chatId, cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç.", cancellationToken);
            }
        }

        private async Task HandleSearchContactStateAsync(long chatId, long userId, string text, CancellationToken cancellationToken)
        {
            if (string.IsNullOrWhiteSpace(text))
            {
                await SendTemporaryMessageAsync(chatId, "–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.", cancellationToken);
                return;
            }

            var contacts = await _contactService.SearchContactsAsync(text);

            if (contacts.Count == 0)
            {
                await SendTemporaryMessageAsync(chatId, $"üîç –ü–æ –∑–∞–ø—Ä–æ—Å—É \"{text}\" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", cancellationToken);
                return;
            }

            var resultText = $"üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É \"{text}\":\n\n";
            foreach (var contact in contacts.Take(15))
            {
                resultText += $"üë§ {contact.TelegramUsername}";
                if (!string.IsNullOrEmpty(contact.FullName))
                    resultText += $" - {contact.FullName}";
                resultText += "\n";
            }

            if (contacts.Count > 15)
            {
                resultText += $"\n... –∏ –µ—â–µ {contacts.Count - 15} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤";
            }

            await SendTemporaryMessageAsync(chatId, resultText, cancellationToken);
        }

        private async Task HandleWriteStatusStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (!state.ProjectId.HasValue)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞: –ø—Ä–æ–µ–∫—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω.", cancellationToken);
                return;
            }

            if (string.IsNullOrWhiteSpace(text))
            {
                await SendTemporaryMessageAsync(chatId, "–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.", cancellationToken);
                return;
            }

            var success = await _projectService.AddStatusUpdateAsync(state.ProjectId.Value, text, userId);
            if (success)
            {
                await SendTemporaryMessageAsync(chatId, "‚úÖ –°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!", cancellationToken);
                await ShowProjectDetailsAsync(chatId, state.ProjectId.Value, cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å.", cancellationToken);
            }
        }

        private async Task HandleCreateContentPlanStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (state.Step == 1)
            {
                state.Data["title"] = text;
                state.Step = 2;
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞:", cancellationToken);
            }
            else if (state.Step == 2)
            {
                state.Data["goal"] = text;
                state.Step = 3;
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞:", cancellationToken);
            }
            else if (state.Step == 3)
            {
                using var scope = _serviceProvider.CreateScope();
                var dbContext = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();

                var contentPlan = new Advertisement
                {
                    Title = state.Data["title"]?.ToString() ?? "",
                    Type = AdvertisementType.ContentPlan,
                    Goal = state.Data["goal"]?.ToString(),
                    ContentStrategy = text,
                    Status = AdvertisementStatus.Planned,
                    CreatedByUserId = userId,
                    CreatedAt = DateTime.UtcNow
                };

                dbContext.Advertisements.Add(contentPlan);
                await dbContext.SaveChangesAsync();

                await SendTemporaryMessageAsync(chatId, $"‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω \"{contentPlan.Title}\" —Å–æ–∑–¥–∞–Ω!", cancellationToken);
                await _menuManager.ShowAdvertisementMenuAsync(chatId, cancellationToken);
            }
        }

        private async Task HandleCreateCampaignStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (state.Step == 1)
            {
                state.Data["title"] = text;
                state.Step = 2;
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –±—é–¥–∂–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏ –≤ USD (–∏–ª–∏ '-' —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):", cancellationToken);
            }
            else if (state.Step == 2)
            {
                if (text != "-" && decimal.TryParse(text, out decimal budget))
                {
                    state.Data["budget"] = budget;
                }
                state.Step = 3;
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏:", cancellationToken);
            }
            else if (state.Step == 3)
            {
                using var scope = _serviceProvider.CreateScope();
                var dbContext = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();

                var campaign = new Advertisement
                {
                    Title = state.Data["title"]?.ToString() ?? "",
                    Type = AdvertisementType.AdCampaign,
                    Goal = text,
                    Budget = state.Data.ContainsKey("budget") ? (decimal?)state.Data["budget"] : null,
                    Status = AdvertisementStatus.Planned,
                    CreatedByUserId = userId,
                    CreatedAt = DateTime.UtcNow
                };

                dbContext.Advertisements.Add(campaign);
                await dbContext.SaveChangesAsync();

                await SendTemporaryMessageAsync(chatId, $"‚úÖ –†–µ–∫–ª–∞–º–Ω–∞—è –∫–∞–º–ø–∞–Ω–∏—è \"{campaign.Title}\" —Å–æ–∑–¥–∞–Ω–∞!", cancellationToken);
                await _menuManager.ShowAdvertisementMenuAsync(chatId, cancellationToken);
            }
        }
        #endregion

        #region –ö–æ–Ω—Ç–∞–∫—Ç—ã - –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleContactsCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case CallbackData.ContactsAdd:
                    _userStates[userId] = new UserState
                    {
                        CurrentAction = UserActions.AddContact,
                        Step = 1
                    };
                    await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ Telegram username (–Ω–∞–ø—Ä–∏–º–µ—Ä: @username –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ username):", cancellationToken);
                    break;

                case CallbackData.ContactsSearch:
                    _userStates[userId] = new UserState
                    {
                        CurrentAction = UserActions.SearchContact,
                        Step = 1
                    };
                    await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –∏–º—è, username –∏–ª–∏ —Ç–µ–≥ –¥–ª—è –ø–æ–∏—Å–∫–∞:", cancellationToken);
                    break;

                case CallbackData.ContactsList:
                    await ShowAllContactsAsync(chatId, cancellationToken);
                    break;

                default:
                    if (callbackData.StartsWith("contact_"))
                    {
                        var contactIdStr = callbackData.Replace("contact_", "");
                        if (int.TryParse(contactIdStr, out int contactId))
                        {
                            await ShowContactDetailsAsync(chatId, contactId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("contact_edit_"))
                    {
                        var contactIdStr = callbackData.Replace("contact_edit_", "");
                        if (int.TryParse(contactIdStr, out int contactId))
                        {
                            await ShowContactEditMenuAsync(chatId, contactId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("contact_delete_"))
                    {
                        var contactIdStr = callbackData.Replace("contact_delete_", "");
                        if (int.TryParse(contactIdStr, out int contactId))
                        {
                            await ShowDeleteContactConfirmationAsync(chatId, contactId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("delete_contact_confirm_"))
                    {
                        var contactIdStr = callbackData.Replace("delete_contact_confirm_", "");
                        if (int.TryParse(contactIdStr, out int contactId))
                        {
                            await DeleteContactAsync(chatId, contactId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("delete_contact_cancel_"))
                    {
                        var contactIdStr = callbackData.Replace("delete_contact_cancel_", "");
                        if (int.TryParse(contactIdStr, out int contactId))
                        {
                            await ShowContactDetailsAsync(chatId, contactId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("contact_edit_name_"))
                    {
                        var contactIdStr = callbackData.Replace("contact_edit_name_", "");
                        if (int.TryParse(contactIdStr, out int contactId))
                        {
                            _userStates[userId] = new UserState
                            {
                                CurrentAction = "edit_contact_name",
                                Data = new Dictionary<string, object?> { ["contactId"] = contactId },
                                Step = 1
                            };
                            await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞:", cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("contact_edit_tags_"))
                    {
                        var contactIdStr = callbackData.Replace("contact_edit_tags_", "");
                        if (int.TryParse(contactIdStr, out int contactId))
                        {
                            _userStates[userId] = new UserState
                            {
                                CurrentAction = "edit_contact_tags",
                                Data = new Dictionary<string, object?> { ["contactId"] = contactId },
                                Step = 1
                            };
                            await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):", cancellationToken);
                        }
                    }
                    break;
            }
        }

        private async Task ShowAllContactsAsync(long chatId, CancellationToken cancellationToken)
        {
            var contacts = await _contactService.GetAllContactsAsync();

            if (contacts.Count == 0)
            {
                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    "üì≠ –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—É—Å—Ç.\n\n–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç!",
                    new InlineKeyboardMarkup(new[]
                    {
                new[]
                {
                    InlineKeyboardButton.WithCallbackData("‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç", CallbackData.ContactsAdd),
                    InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToContacts)
                }
                    }),
                    "contacts_list_empty",
                    cancellationToken);
                return;
            }

            var text = $"üë• –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ ({contacts.Count}):\n\n";
            var buttons = new List<List<InlineKeyboardButton>>();

            foreach (var contact in contacts.Take(15))
            {
                var displayName = !string.IsNullOrEmpty(contact.FullName)
                    ? $"{contact.FullName}"
                    : $"@{contact.TelegramUsername}";

                buttons.Add(new List<InlineKeyboardButton>
        {
            InlineKeyboardButton.WithCallbackData(
                $"üë§ {displayName}",
                $"contact_{contact.Id}")
        });
            }

            if (contacts.Count > 15)
            {
                text += $"\n... –∏ –µ—â–µ {contacts.Count - 15} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤";
            }

            buttons.Add(new List<InlineKeyboardButton>
    {
        InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToContacts)
    });

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "contacts_list",
                cancellationToken);
        }

        private async Task ShowContactDetailsAsync(long chatId, int contactId, CancellationToken cancellationToken)
        {
            var contact = await _contactService.GetContactAsync(contactId);
            if (contact == null)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", cancellationToken);
                await _menuManager.ShowContactsMenuAsync(chatId, cancellationToken);
                return;
            }

            var text = $"üë§ –ö–æ–Ω—Ç–∞–∫—Ç\n\n" +
                      $"Username: @{contact.TelegramUsername}\n";

            if (!string.IsNullOrEmpty(contact.FullName))
                text += $"–ò–º—è: {contact.FullName}\n";

            if (!string.IsNullOrEmpty(contact.Nickname))
                text += $"–ü—Å–µ–≤–¥–æ–Ω–∏–º: {contact.Nickname}\n";

            if (!string.IsNullOrEmpty(contact.ContactType))
                text += $"–¢–∏–ø: {contact.ContactType}\n";

            if (!string.IsNullOrEmpty(contact.Tags))
                text += $"–¢–µ–≥–∏: {contact.Tags}\n";

            text += $"\n–î–æ–±–∞–≤–ª–µ–Ω: {contact.CreatedAt:dd.MM.yyyy}";

            var buttons = new List<List<InlineKeyboardButton>>
    {
        new() { InlineKeyboardButton.WithCallbackData("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", $"contact_edit_{contact.Id}") },
        new() { InlineKeyboardButton.WithCallbackData("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", $"contact_delete_{contact.Id}") },
        new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToContacts) }
    };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                $"contact_{contact.Id}",
                cancellationToken);
        }

        private async Task ShowContactEditMenuAsync(long chatId, int contactId, CancellationToken cancellationToken)
        {
            var contact = await _contactService.GetContactAsync(contactId);
            if (contact == null)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", cancellationToken);
                return;
            }

            var text = $"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞\n\n" +
                      $"–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ:\n" +
                      $"Username: @{contact.TelegramUsername}\n" +
                      $"–ò–º—è: {contact.FullName ?? "–ù–µ —É–∫–∞–∑–∞–Ω–æ"}\n" +
                      $"–¢–µ–≥–∏: {contact.Tags ?? "–ù–µ —É–∫–∞–∑–∞–Ω—ã"}\n\n" +
                      $"–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?";

            var buttons = new List<List<InlineKeyboardButton>>
    {
        new() { InlineKeyboardButton.WithCallbackData("üë§ –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è", $"contact_edit_name_{contactId}") },
        new() { InlineKeyboardButton.WithCallbackData("üè∑Ô∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–≥–∏", $"contact_edit_tags_{contactId}") },
        new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", $"contact_{contactId}") }
    };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                $"contact_edit_{contactId}",
                cancellationToken);
        }

        private async Task ShowDeleteContactConfirmationAsync(long chatId, int contactId, CancellationToken cancellationToken)
        {
            var contact = await _contactService.GetContactAsync(contactId);
            if (contact == null)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", cancellationToken);
                return;
            }

            await _menuManager.ShowDeleteConfirmationAsync(
                chatId,
                "–∫–æ–Ω—Ç–∞–∫—Ç",
                $"Username: @{contact.TelegramUsername}\n–ò–º—è: {contact.FullName ?? "–ù–µ —É–∫–∞–∑–∞–Ω–æ"}",
                $"delete_contact_confirm_{contactId}",
                $"contact_{contactId}",
                cancellationToken);
        }

        private async Task DeleteContactAsync(long chatId, int contactId, CancellationToken cancellationToken)
        {
            var success = await _contactService.DeleteContactAsync(contactId);
            if (success)
            {
                await SendTemporaryMessageAsync(chatId, "‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.", cancellationToken);
                await _menuManager.ShowContactsMenuAsync(chatId, cancellationToken);
            }
            else
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç.", cancellationToken);
            }
        }
        #endregion

        #region –°—Ç–∞—Ç—É—Å—ã - –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleStatusCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case CallbackData.StatusWrite:
                    await ShowProjectSelectionForStatusAsync(chatId, userId, cancellationToken);
                    break;

                case CallbackData.StatusBoard:
                    await ShowStatusBoardAsync(chatId, cancellationToken);
                    break;

                case CallbackData.StatusProgress:
                    await ShowProgressOverviewAsync(chatId, cancellationToken);
                    break;

                default:
                    if (callbackData.StartsWith("status_project_"))
                    {
                        var projectIdStr = callbackData.Replace("status_project_", "");
                        if (int.TryParse(projectIdStr, out int projectId))
                        {
                            await ShowProjectStatusHistoryAsync(chatId, projectId, cancellationToken);
                        }
                    }
                    else if (callbackData.StartsWith("write_status_for_"))
                    {
                        var projectIdStr = callbackData.Replace("write_status_for_", "");
                        if (int.TryParse(projectIdStr, out int projectId))
                        {
                            _userStates[userId] = new UserState
                            {
                                CurrentAction = UserActions.WriteStatus,
                                ProjectId = projectId,
                                Step = 1
                            };
                            await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞:", cancellationToken);
                        }
                    }
                    break;
            }
        }

        private async Task ShowProjectSelectionForStatusAsync(long chatId, long userId, CancellationToken cancellationToken)
        {
            var projects = await _projectService.GetAllProjectsAsync();
            var activeProjects = projects.Where(p => p.Status != ProjectStatus.Completed).ToList();

            if (activeProjects.Count == 0)
            {
                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    "üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.",
                    new InlineKeyboardMarkup(new[]
                    {
                new[]
                {
                    InlineKeyboardButton.WithCallbackData("üìÇ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç", CallbackData.CreateProject),
                    InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToStatuses)
                }
                    }),
                    "status_project_selection",
                    cancellationToken);
                return;
            }

            var text = "üìù –ù–∞–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:";
            var buttons = new List<List<InlineKeyboardButton>>();

            foreach (var project in activeProjects.Take(10))
            {
                var statusIcon = project.Status switch
                {
                    ProjectStatus.Pending => "üü°",
                    ProjectStatus.InProgress => "üü†",
                    _ => "‚ö™"
                };

                buttons.Add(new List<InlineKeyboardButton>
        {
            InlineKeyboardButton.WithCallbackData(
                $"{statusIcon} {project.Name}",
                $"write_status_for_{project.Id}")
        });
            }

            buttons.Add(new List<InlineKeyboardButton>
    {
        InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToStatuses)
    });

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "status_project_selection",
                cancellationToken);
        }

        private async Task ShowStatusBoardAsync(long chatId, CancellationToken cancellationToken)
        {
            var projects = await _projectService.GetAllProjectsAsync();
            var activeProjects = projects.Where(p => p.Status != ProjectStatus.Completed).Take(5).ToList();

            var text = "üó∫Ô∏è –°—Ç–∞—Ç—É—Å–Ω–∞—è –¥–æ—Å–∫–∞\n\n";

            if (activeProjects.Count == 0)
            {
                text += "üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.\n\n";
            }
            else
            {
                foreach (var project in activeProjects)
                {
                    var statusIcon = project.Status switch
                    {
                        ProjectStatus.Pending => "üü° –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç",
                        ProjectStatus.InProgress => "üü† –í —Ä–∞–±–æ—Ç–µ",
                        _ => "‚ö™ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                    };

                    var tasks = project.Tasks?.ToList() ?? new List<TeamTask>();
                    var activeTasks = tasks.Count(t => t.Status == TeamTaskStatus.Active);
                    var completedTasks = tasks.Count(t => t.Status == TeamTaskStatus.Completed);

                    text += $"{statusIcon} {project.Name}\n";
                    text += $"   –ó–∞–¥–∞—á–∏: {activeTasks} –∞–∫—Ç–∏–≤–Ω—ã—Ö, {completedTasks} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ\n\n";
                }
            }

            text += "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n";
            text += $"‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {projects.Count}\n";
            text += $"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤: {activeProjects.Count}\n";
            text += $"‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤: {projects.Count(p => p.Status == ProjectStatus.Completed)}\n";

            var buttons = new List<List<InlineKeyboardButton>>
    {
        new() { InlineKeyboardButton.WithCallbackData("üìù –ù–∞–ø–∏—Å–∞—Ç—å —Å—Ç–∞—Ç—É—Å", CallbackData.StatusWrite) },
        new() { InlineKeyboardButton.WithCallbackData("üìà –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "status_detailed_stats") },
        new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToStatuses) }
    };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "status_board",
                cancellationToken);
        }

        private async Task ShowProgressOverviewAsync(long chatId, CancellationToken cancellationToken)
        {
            var projects = await _projectService.GetAllProjectsAsync();

            var completedProjects = projects.Count(p => p.Status == ProjectStatus.Completed);
            var totalProjects = projects.Count;
            var completionRate = totalProjects > 0 ? (decimal)completedProjects / totalProjects * 100 : 0;

            // –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∑–∞–¥–∞—á–∞–º
            var allTasks = new List<TeamTask>();
            foreach (var project in projects)
            {
                if (project.Tasks != null)
                    allTasks.AddRange(project.Tasks);
            }

            var completedTasks = allTasks.Count(t => t.Status == TeamTaskStatus.Completed);
            var totalTasks = allTasks.Count;
            var taskCompletionRate = totalTasks > 0 ? (decimal)completedTasks / totalTasks * 100 : 0;

            var text = $"üìà –û–±–∑–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n\n" +
                      $"üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º:\n" +
                      $"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: {completedProjects}/{totalProjects} ({completionRate:F1}%)\n\n" +
                      $"‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∑–∞–¥–∞—á–∞–º:\n" +
                      $"üü¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {completedTasks}/{totalTasks} ({taskCompletionRate:F1}%)\n\n" +
                      $"üèÜ –°–∞–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã:\n";

            var productiveProjects = projects
                .Where(p => p.Tasks != null && p.Tasks.Any())
                .OrderByDescending(p => p.Tasks.Count(t => t.Status == TeamTaskStatus.Completed))
                .Take(3);

            int rank = 1;
            foreach (var project in productiveProjects)
            {
                var projectCompletedTasks = project.Tasks.Count(t => t.Status == TeamTaskStatus.Completed);
                var projectTotalTasks = project.Tasks.Count;
                var projectRate = projectTotalTasks > 0 ? (decimal)projectCompletedTasks / projectTotalTasks * 100 : 0;
                text += $"{rank}. {project.Name}: {projectCompletedTasks}/{projectTotalTasks} ({projectRate:F1}%)\n";
                rank++;
            }

            var buttons = new List<List<InlineKeyboardButton>>
    {
        new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é", "progress_week") },
        new() { InlineKeyboardButton.WithCallbackData("üìÖ –ó–∞ –º–µ—Å—è—Ü", "progress_month") },
        new() { InlineKeyboardButton.WithCallbackData("üìä –ì—Ä–∞—Ñ–∏–∫–∏", "progress_charts") },
        new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToStatuses) }
    };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                "progress_overview",
                cancellationToken);
        }

        private async Task ShowProjectStatusHistoryAsync(long chatId, int projectId, CancellationToken cancellationToken)
        {
            var project = await _projectService.GetProjectAsync(projectId);
            if (project == null)
            {
                await SendTemporaryMessageAsync(chatId, "‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", cancellationToken);
                return;
            }

            var statusUpdates = await _projectService.GetProjectStatusHistoryAsync(projectId, 10);

            var text = $"üìù –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞\n" +
                      $"üìÇ –ü—Ä–æ–µ–∫—Ç: {project.Name}\n\n";

            if (statusUpdates.Count == 0)
            {
                text += "üì≠ –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—É—Å—Ç–∞.\n";
            }
            else
            {
                foreach (var update in statusUpdates.OrderByDescending(s => s.CreatedAt))
                {
                    var date = update.CreatedAt.ToString("dd.MM.yyyy HH:mm");
                    var author = update.CreatedBy?.Username ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
                    text += $"üìÖ {date} (@{author}):\n{update.Text}\n\n";
                }
            }

            var buttons = new List<List<InlineKeyboardButton>>
    {
        new() { InlineKeyboardButton.WithCallbackData("üìù –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å", $"write_status_for_{projectId}") },
        new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.StatusBoard) }
    };

            await _menuManager.ShowInlineMenuAsync(
                chatId,
                text,
                new InlineKeyboardMarkup(buttons),
                $"status_history_{projectId}",
                cancellationToken);
        }
        #endregion

        #region –ù–∞–≤–∏–≥–∞—Ü–∏—è
        private async Task HandleNavigationCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            var isAdmin = await _userService.IsAdminAsync(userId);

            switch (callbackData)
            {
                case CallbackData.BackToMain:
                    await _menuManager.ShowMainMenuAsync(chatId, userId, isAdmin, cancellationToken);
                    break;

                case CallbackData.BackToProjects:
                    await _menuManager.ShowProjectsMenuAsync(chatId, cancellationToken);
                    break;

                case CallbackData.BackToTasks:
                    await _menuManager.ShowTasksMenuAsync(chatId, isAdmin, cancellationToken);
                    break;

                case CallbackData.BackToStatuses:
                    await _menuManager.ShowStatusesMenuAsync(chatId, cancellationToken);
                    break;

                case CallbackData.BackToAdvertisement:
                    await _menuManager.ShowAdvertisementMenuAsync(chatId, cancellationToken);
                    break;

                case CallbackData.BackToContacts:
                    await _menuManager.ShowContactsMenuAsync(chatId, cancellationToken);
                    break;

                case CallbackData.BackToDatabase:
                    await _menuManager.ShowDatabaseMenuAsync(chatId, cancellationToken);
                    break;

                case CallbackData.BackToFinance:
                    await _menuManager.ShowFinanceMenuAsync(chatId, cancellationToken);
                    break;

                case CallbackData.BackToKpi:
                    await _menuManager.ShowKPIMenuAsync(chatId, cancellationToken);
                    break;

                case CallbackData.BackToSettings:
                    await _menuManager.ShowSettingsMenuAsync(chatId, cancellationToken);
                    break;
            }
        }
        #endregion

        #region –ù–∞—Å—Ç—Ä–æ–π–∫–∏ - –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleSettingsCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            var user = await _userService.GetUserByTelegramIdAsync(userId);
            if (user == null || user.Role != UserRole.Admin)
            {
                await SendTemporaryMessageAsync(chatId, "‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.", cancellationToken);
                return;
            }

            switch (callbackData)
            {
                case CallbackData.SettingsUsers:
                    await ShowUsersManagementAsync(chatId, cancellationToken);
                    break;

                case CallbackData.SettingsSecurity:
                    await ShowSecuritySettingsAsync(chatId, cancellationToken);
                    break;

                case CallbackData.SettingsReports:
                    await ShowReportsSettingsAsync(chatId, cancellationToken);
                    break;

                case CallbackData.SettingsDatabase:
                    await ShowDatabaseSettingsAsync(chatId, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.", cancellationToken);
                    break;
            }
        }

        private async Task ShowUsersManagementAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var users = await _userService.GetAllUsersAsync();
                var text = $"üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ ({users.Count})\n\n";

                foreach (var user in users.Take(10))
                {
                    text += $"‚Ä¢ @{user.Username} - {(user.Role == UserRole.Admin ? "üëë –ê–¥–º–∏–Ω" : "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")}\n";
                }

                if (users.Count > 10)
                {
                    text += $"\n... –∏ –µ—â–µ {users.Count - 10} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π";
                }

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞", "settings_add_admin") },
            new() { InlineKeyboardButton.WithCallbackData("‚ûñ –£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∞", "settings_remove_admin") },
            new() { InlineKeyboardButton.WithCallbackData("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "settings_users_stats") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToSettings) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "settings_users",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing users management");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.", cancellationToken);
            }
        }

        private async Task ShowSecuritySettingsAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var users = await _userService.GetAllUsersAsync();
                var activeUsers = users.Count(u => u.LastActiveAt >= DateTime.UtcNow.AddDays(-7));
                var totalUsers = users.Count;
                var activePercentage = totalUsers > 0 ? (decimal)activeUsers / totalUsers * 100 : 0;

                var text = $"üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n\n" +
                           $"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {totalUsers}\n" +
                           $"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö (–Ω–µ–¥–µ–ª—è): {activeUsers} ({activePercentage:F1}%)\n" +
                           $"‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {users.Count(u => u.Role == UserRole.Admin)}\n" +
                           $"‚Ä¢ –ù–æ–≤—ã—Ö (–º–µ—Å—è—Ü): {users.Count(u => u.CreatedAt >= DateTime.UtcNow.AddMonths(-1))}\n\n" +
                           $"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏:\n" +
                           $"‚Ä¢ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è: ‚úÖ –í–∫–ª—é—á–µ–Ω–∞\n" +
                           $"‚Ä¢ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π: ‚úÖ –í–∫–ª—é—á–µ–Ω–æ";

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üìã –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "security_logs") },
            new() { InlineKeyboardButton.WithCallbackData("üë• –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏", "security_sessions") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToSettings) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "settings_security",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing security settings");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.", cancellationToken);
            }
        }

        private async Task ShowReportsSettingsAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                var projects = await _projectService.GetAllProjectsAsync();
                var tasks = await _taskService.GetAllTasksAsync();
                var financeRecords = await _financeService.GetAllRecordsAsync();

                var text = $"üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–æ–≤\n\n" +
                           $"üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö:\n" +
                           $"‚Ä¢ –ü—Ä–æ–µ–∫—Ç–æ–≤: {projects.Count}\n" +
                           $"‚Ä¢ –ó–∞–¥–∞—á: {tasks.Count}\n" +
                           $"‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π: {financeRecords.Count}\n\n" +
                           $"üìÖ –ß–∞—Å—Ç–æ—Ç–∞ –æ—Ç—á–µ—Ç–æ–≤:\n" +
                           $"‚Ä¢ –ê–≤—Ç–æ–æ—Ç—á–µ—Ç—ã: ‚úÖ –í–∫–ª—é—á–µ–Ω—ã\n" +
                           $"‚Ä¢ –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ\n" +
                           $"‚Ä¢ –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: 09:00\n\n" +
                           $"üìß –ü–æ–ª—É—á–∞—Ç–µ–ª–∏:\n" +
                           $"‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã: ‚úÖ –í—Å–µ";

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üìÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É", "settings_reports_frequency") },
            new() { InlineKeyboardButton.WithCallbackData("üìß –ù–∞—Å—Ç—Ä–æ–∏—Ç—å email", "settings_reports_email") },
            new() { InlineKeyboardButton.WithCallbackData("üìÅ –§–æ—Ä–º–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞", "settings_reports_export") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToSettings) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "settings_reports",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing reports settings");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç—á–µ—Ç–æ–≤.", cancellationToken);
            }
        }

        private async Task ShowDatabaseSettingsAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º —Ç–∞–±–ª–∏—Ü–∞–º
                var usersCount = (await _userService.GetAllUsersAsync()).Count;
                var projectsCount = (await _projectService.GetAllProjectsAsync()).Count;
                var tasksCount = (await _taskService.GetAllTasksAsync()).Count;
                var contactsCount = (await _contactService.GetAllContactsAsync()).Count;
                var financeCount = (await _financeService.GetAllRecordsAsync()).Count;

                var totalRecords = usersCount + projectsCount + tasksCount + contactsCount + financeCount;

                var text = $"üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n\n" +
                           $"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø–∏—Å–µ–π:\n" +
                           $"‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {usersCount}\n" +
                           $"‚Ä¢ –ü—Ä–æ–µ–∫—Ç—ã: {projectsCount}\n" +
                           $"‚Ä¢ –ó–∞–¥–∞—á–∏: {tasksCount}\n" +
                           $"‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç—ã: {contactsCount}\n" +
                           $"‚Ä¢ –§–∏–Ω–∞–Ω—Å—ã: {financeCount}\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ: {totalRecords}\n\n" +
                           $"üîÑ –ê–≤—Ç–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ:\n" +
                           $"‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: {DateTime.UtcNow.AddHours(-2):dd.MM.yyyy HH:mm}\n" +
                           $"‚Ä¢ –°–ª–µ–¥—É—é—â–∏–π –±—ç–∫–∞–ø: {DateTime.UtcNow.AddHours(22):dd.MM.yyyy HH:mm}";

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üíæ –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø", "settings_db_backup") },
            new() { InlineKeyboardButton.WithCallbackData("üîÑ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å", "settings_db_optimize") },
            new() { InlineKeyboardButton.WithCallbackData("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "settings_db_stats") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToSettings) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "settings_database",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing database settings");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.", cancellationToken);
            }
        }
        #endregion

        #region KPI - –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleKpiCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case CallbackData.KpiTasksWeek:
                    await ShowKpiTasksWeekAsync(chatId, cancellationToken);
                    break;

                case CallbackData.KpiFinanceMonth:
                    await ShowKpiFinanceMonthAsync(chatId, cancellationToken);
                    break;

                case CallbackData.KpiProjects:
                    await ShowKpiProjectsAsync(chatId, cancellationToken);
                    break;

                case CallbackData.KpiActivity:
                    await ShowKpiActivityAsync(chatId, cancellationToken);
                    break;

                case CallbackData.KpiOverall:
                    await ShowKpiOverallAsync(chatId, cancellationToken);
                    break;

                case CallbackData.KpiTeam:
                    await ShowKpiTeamAsync(chatId, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç—á–µ—Ç KPI.", cancellationToken);
                    break;
            }
        }

        private async Task ShowKpiTasksWeekAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var weekStart = DateTime.UtcNow.AddDays(-7);

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ GetTasksByDateRangeAsync –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                var allTasks = await _taskService.GetAllTasksAsync();
                var weekTasks = allTasks.Where(t => t.CreatedAt >= weekStart).ToList();

                var completedTasks = weekTasks.Count(t => t.Status == TeamTaskStatus.Completed);
                var activeTasks = weekTasks.Count(t => t.Status == TeamTaskStatus.Active);
                var totalTasks = weekTasks.Count;

                var completionRate = totalTasks > 0 ? (decimal)completedTasks / totalTasks * 100 : 0;

                // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                double avgCompletionTime = 0;
                var completedTasksWithDate = weekTasks
                    .Where(t => t.Status == TeamTaskStatus.Completed && t.CompletedAt.HasValue)
                    .ToList();

                if (completedTasksWithDate.Any())
                {
                    avgCompletionTime = completedTasksWithDate
                        .Average(t => (t.CompletedAt!.Value - t.CreatedAt).TotalDays);
                }

                var text = $"üìä KPI: –ó–∞–¥–∞—á–∏ –∑–∞ –Ω–µ–¥–µ–ª—é\n\n" +
                           $"üìÖ –ü–µ—Ä–∏–æ–¥: {weekStart:dd.MM.yyyy} - {DateTime.UtcNow:dd.MM.yyyy}\n\n" +
                           $"üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –∑–∞–¥–∞—á: {totalTasks}\n" +
                           $"‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {completedTasks} ({completionRate:F1}%)\n" +
                           $"‚Ä¢ –í —Ä–∞–±–æ—Ç–µ: {activeTasks}\n" +
                           $"‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {avgCompletionTime:F1} –¥–Ω–µ–π\n\n";

                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–∞–¥–∞—á –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–¥–∞—á–∏
                if (weekTasks.Any(t => t.AssignedToUserId != 0))
                {
                    text += $"üèÜ –¢–æ–ø –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π:\n";

                    var userStats = weekTasks
                        .Where(t => t.AssignedToUserId != 0)
                        .GroupBy(t => t.AssignedToUserId)
                        .Select(g => new
                        {
                            UserId = g.Key,
                            Completed = g.Count(t => t.Status == TeamTaskStatus.Completed),
                            Total = g.Count()
                        })
                        .OrderByDescending(x => x.Completed)
                        .Take(3)
                        .ToList();

                    foreach (var stat in userStats)
                    {
                        var user = await _userService.GetUserByTelegramIdAsync(stat.UserId);
                        var rate = stat.Total > 0 ? (decimal)stat.Completed / stat.Total * 100 : 0;
                        text += $"‚Ä¢ @{user?.Username ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}: {stat.Completed}/{stat.Total} ({rate:F1}%)\n";
                    }
                }
                else
                {
                    text += "üì≠ –ù–µ—Ç –∑–∞–¥–∞—á –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥.\n";
                }

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    MainMenuKeyboard.GetBackButton(CallbackData.BackToKpi),
                    "kpi_tasks_week",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing KPI tasks week");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ KPI –ø–æ –∑–∞–¥–∞—á–∞–º.", cancellationToken);
            }
        }

        private async Task ShowKpiFinanceMonthAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var monthStart = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                var allIncomes = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Income);
                var allExpenses = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Expense);

                var monthlyIncomes = allIncomes
                    .Where(i => i.TransactionDate >= monthStart)
                    .Sum(i => i.Amount);
                var monthlyExpenses = allExpenses
                    .Where(e => e.TransactionDate >= monthStart)
                    .Sum(e => e.Amount);
                var profit = monthlyIncomes - monthlyExpenses;
                var profitMargin = monthlyIncomes > 0 ? profit / monthlyIncomes * 100 : 0;

                var text = $"üí∞ KPI: –§–∏–Ω–∞–Ω—Å—ã –∑–∞ –º–µ—Å—è—Ü\n\n" +
                           $"üìÖ –ü–µ—Ä–∏–æ–¥: {monthStart:MMMM yyyy}\n\n" +
                           $"üìä –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:\n" +
                           $"‚Ä¢ –î–æ—Ö–æ–¥—ã: {monthlyIncomes:N2} USD\n" +
                           $"‚Ä¢ –†–∞—Å—Ö–æ–¥—ã: {monthlyExpenses:N2} USD\n" +
                           $"‚Ä¢ –ü—Ä–∏–±—ã–ª—å: {profit:N2} USD\n" +
                           $"‚Ä¢ –ú–∞—Ä–∂–∞ –ø—Ä–∏–±—ã–ª–∏: {profitMargin:F1}%\n\n";

                // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤
                var incomeByCategory = allIncomes
                    .Where(i => i.TransactionDate >= monthStart)
                    .GroupBy(i => i.Category)
                    .Select(g => new { Category = g.Key, Amount = g.Sum(i => i.Amount) })
                    .OrderByDescending(x => x.Amount)
                    .Take(3)
                    .ToList();

                if (incomeByCategory.Any())
                {
                    text += $"üìà –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ—Ö–æ–¥–æ–≤:\n";
                    foreach (var category in incomeByCategory)
                    {
                        var percentage = monthlyIncomes > 0 ? category.Amount / monthlyIncomes * 100 : 0;
                        text += $"‚Ä¢ {category.Category}: {category.Amount:N2} USD ({percentage:F1}%)\n";
                    }
                }

                // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
                var expensesByCategory = allExpenses
                    .Where(e => e.TransactionDate >= monthStart)
                    .GroupBy(e => e.Category)
                    .Select(g => new { Category = g.Key, Amount = g.Sum(e => e.Amount) })
                    .OrderByDescending(x => x.Amount)
                    .Take(3)
                    .ToList();

                if (expensesByCategory.Any())
                {
                    text += $"\nüìâ –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤:\n";
                    foreach (var category in expensesByCategory)
                    {
                        var percentage = monthlyExpenses > 0 ? category.Amount / monthlyExpenses * 100 : 0;
                        text += $"‚Ä¢ {category.Category}: {category.Amount:N2} USD ({percentage:F1}%)\n";
                    }
                }

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    MainMenuKeyboard.GetBackButton(CallbackData.BackToKpi),
                    "kpi_finance_month",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing KPI finance month");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ KPI –ø–æ —Ñ–∏–Ω–∞–Ω—Å–∞–º.", cancellationToken);
            }
        }

        private async Task ShowKpiProjectsAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var projects = await _projectService.GetAllProjectsAsync();

                var completedProjects = projects.Count(p => p.Status == ProjectStatus.Completed);
                var inProgressProjects = projects.Count(p => p.Status == ProjectStatus.InProgress);
                var pendingProjects = projects.Count(p => p.Status == ProjectStatus.Pending);
                var totalProjects = projects.Count;

                var completionRate = totalProjects > 0 ? (decimal)completedProjects / totalProjects * 100 : 0;

                var text = $"üìÇ KPI: –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–µ–∫—Ç–æ–≤\n\n" +
                           $"üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–æ–≤:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {totalProjects}\n" +
                           $"‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: {completedProjects} ({completionRate:F1}%)\n" +
                           $"‚Ä¢ –í —Ä–∞–±–æ—Ç–µ: {inProgressProjects}\n" +
                           $"‚Ä¢ –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç: {pendingProjects}\n\n";

                // –°–∞–º—ã–µ —É—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã (–ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–¥–∞—á)
                var projectsWithTasks = projects
                    .Where(p => p.Tasks != null && p.Tasks.Any())
                    .Select(p => new
                    {
                        Project = p,
                        CompletedTasks = p.Tasks.Count(t => t.Status == TeamTaskStatus.Completed),
                        TotalTasks = p.Tasks.Count()
                    })
                    .Where(x => x.TotalTasks > 0)
                    .OrderByDescending(x => (decimal)x.CompletedTasks / x.TotalTasks * 100)
                    .Take(3)
                    .ToList();

                if (projectsWithTasks.Any())
                {
                    text += $"üèÜ –°–∞–º—ã–µ —É—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã:\n";
                    foreach (var project in projectsWithTasks)
                    {
                        var completionRateProject = project.TotalTasks > 0 ?
                            (decimal)project.CompletedTasks / project.TotalTasks * 100 : 0;
                        text += $"‚Ä¢ {project.Project.Name}: {project.CompletedTasks}/{project.TotalTasks} ({completionRateProject:F1}%)\n";
                    }
                }

                // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
                if (projects.Any())
                {
                    var avgTasksPerProject = projects.Average(p => p.Tasks?.Count ?? 0);
                    var recentProjects = projects
                        .Where(p => p.Status == ProjectStatus.Completed && p.UpdatedAt.HasValue)
                        .ToList();

                    double avgCompletionDays = 0;
                    if (recentProjects.Any())
                    {
                        avgCompletionDays = recentProjects
                            .Average(p => (p.UpdatedAt!.Value - p.CreatedAt).TotalDays);
                    }

                    text += $"\nüìà –°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:\n";
                    text += $"‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞: {avgCompletionDays:F1} –¥–Ω–µ–π\n";
                    text += $"‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –Ω–∞ –ø—Ä–æ–µ–∫—Ç: {avgTasksPerProject:F1}\n";
                }

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    MainMenuKeyboard.GetBackButton(CallbackData.BackToKpi),
                    "kpi_projects",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing KPI projects");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ KPI –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º.", cancellationToken);
            }
        }

        private async Task ShowKpiActivityAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var weekStart = DateTime.UtcNow.AddDays(-7);
                var users = await _userService.GetAllUsersAsync();

                var activeUsers = users.Count(u => u.LastActiveAt >= weekStart);
                var newUsers = users.Count(u => u.CreatedAt >= weekStart);
                var totalUsers = users.Count;

                var activityPercentage = totalUsers > 0 ? (decimal)activeUsers / totalUsers * 100 : 0;

                var text = $"üë• KPI: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n\n" +
                           $"üìÖ –ü–µ—Ä–∏–æ–¥: {weekStart:dd.MM.yyyy} - {DateTime.UtcNow:dd.MM.yyyy}\n\n" +
                           $"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {totalUsers}\n" +
                           $"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é: {activeUsers} ({(activityPercentage):F1}%)\n" +
                           $"‚Ä¢ –ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é: {newUsers}\n\n";

                // –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                var activeUsersList = users
                    .Where(u => u.LastActiveAt.HasValue)
                    .OrderByDescending(u => u.LastActiveAt)
                    .Take(5)
                    .ToList();

                if (activeUsersList.Any())
                {
                    text += $"üèÜ –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏:\n";
                    foreach (var user in activeUsersList)
                    {
                        if (user.LastActiveAt.HasValue)
                        {
                            var daysSinceActive = (DateTime.UtcNow - user.LastActiveAt.Value).Days;
                            var activityText = daysSinceActive == 0 ? "—Å–µ–≥–æ–¥–Ω—è" :
                                              daysSinceActive == 1 ? "–≤—á–µ—Ä–∞" :
                                              $"{daysSinceActive} –¥–Ω. –Ω–∞–∑–∞–¥";

                            text += $"‚Ä¢ @{user.Username} - –±—ã–ª {activityText}\n";
                        }
                    }
                }

                // –ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –¥–Ω—è–º (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
                var activeUsersByDay = new Dictionary<DayOfWeek, int>();
                foreach (var user in users.Where(u => u.LastActiveAt.HasValue && u.LastActiveAt >= weekStart))
                {
                    var day = user.LastActiveAt!.Value.DayOfWeek;
                    activeUsersByDay[day] = activeUsersByDay.GetValueOrDefault(day) + 1;
                }

                if (activeUsersByDay.Any())
                {
                    text += $"\nüìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏:\n";
                    var daysOfWeek = new[] { DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday,
                                   DayOfWeek.Thursday, DayOfWeek.Friday, DayOfWeek.Saturday, DayOfWeek.Sunday };

                    foreach (var day in daysOfWeek)
                    {
                        var count = activeUsersByDay.GetValueOrDefault(day);
                        var percentage = activeUsers > 0 ? (decimal)count / activeUsers * 100 : 0;
                        text += $"‚Ä¢ {GetDayName(day)}: {count} ({(percentage):F1}%)\n";
                    }
                }

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    MainMenuKeyboard.GetBackButton(CallbackData.BackToKpi),
                    "kpi_activity",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing KPI activity");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ KPI –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.", cancellationToken);
            }
        }

        private async Task ShowKpiOverallAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ KPI
                var projects = await _projectService.GetAllProjectsAsync();
                var tasks = await _taskService.GetAllTasksAsync();
                var incomes = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Income);
                var expenses = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Expense);

                // –†–∞—Å—á–µ—Ç—ã
                var completedProjects = projects.Count(p => p.Status == ProjectStatus.Completed);
                var totalProjects = projects.Count;
                var projectCompletionRate = totalProjects > 0 ? (decimal)completedProjects / totalProjects * 100 : 0;

                var completedTasks = tasks.Count(t => t.Status == TeamTaskStatus.Completed);
                var totalTasks = tasks.Count;
                var taskCompletionRate = totalTasks > 0 ? (decimal)completedTasks / totalTasks * 100 : 0;

                var totalIncome = incomes.Sum(i => i.Amount);
                var totalExpenses = expenses.Sum(e => e.Amount);
                var profit = totalIncome - totalExpenses;
                var profitMargin = totalIncome > 0 ? profit / totalIncome * 100 : 0;

                // –û–±—â–∏–π KPI (–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞)
                var overallKpi = (projectCompletionRate * 0.3m + taskCompletionRate * 0.4m + profitMargin * 0.3m);
                var kpiStatus = overallKpi switch
                {
                    >= 90 => "üíé –û—Ç–ª–∏—á–Ω–æ",
                    >= 75 => "üëç –•–æ—Ä–æ—à–æ",
                    >= 60 => "‚ö†Ô∏è –°—Ä–µ–¥–Ω–µ",
                    _ => "‚ùå –¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è"
                };

                var text = $"üìä –û–±—â–∏–π KPI —Å–∏—Å—Ç–µ–º—ã\n\n" +
                           $"‚≠ê –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: {overallKpi:F1}/100\n" +
                           $"üìã –°—Ç–∞—Ç—É—Å: {kpiStatus}\n\n" +
                           $"üìà –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã KPI:\n" +
                           $"‚Ä¢ –ü—Ä–æ–µ–∫—Ç—ã: {projectCompletionRate:F1}/100 (–≤–µ—Å 30%)\n" +
                           $"‚Ä¢ –ó–∞–¥–∞—á–∏: {taskCompletionRate:F1}/100 (–≤–µ—Å 40%)\n" +
                           $"‚Ä¢ –§–∏–Ω–∞–Ω—Å—ã: {profitMargin:F1}/100 (–≤–µ—Å 30%)\n\n" +
                           $"üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:\n" +
                           $"‚Ä¢ –ü—Ä–æ–µ–∫—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: {completedProjects}/{totalProjects}\n" +
                           $"‚Ä¢ –ó–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {completedTasks}/{totalTasks}\n" +
                           $"‚Ä¢ –ü—Ä–∏–±—ã–ª—å: {profit:N2} USD (–º–∞—Ä–∂–∞: {profitMargin:F1}%)\n\n" +
                           $"üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n";

                if (overallKpi >= 90)
                    text += $"‚Ä¢ –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!\n‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã\n‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ";
                else if (overallKpi >= 75)
                    text += $"‚Ä¢ –£–ª—É—á—à–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á\n‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã\n‚Ä¢ –£—Å–∫–æ—Ä—å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤";
                else if (overallKpi >= 60)
                    text += $"‚Ä¢ –°—Ä–æ—á–Ω–æ —É–ª—É—á—à–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á\n‚Ä¢ –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã\n‚Ä¢ –£–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞";
                else
                    text += $"‚Ä¢ –¢—Ä–µ–±—É–µ—Ç—Å—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ\n‚Ä¢ –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã\n‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥—ã";

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    MainMenuKeyboard.GetBackButton(CallbackData.BackToKpi),
                    "kpi_overall",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing KPI overall");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—â–µ–≥–æ KPI.", cancellationToken);
            }
        }

        private async Task ShowKpiTeamAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var users = await _userService.GetAllUsersAsync();
                var tasks = await _taskService.GetAllTasksAsync();

                var text = $"üë• KPI –∫–æ–º–∞–Ω–¥—ã\n\n" +
                           $"üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥—ã:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {users.Count}\n" +
                           $"‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {users.Count(u => u.Role == UserRole.Admin)}\n" +
                           $"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {users.Count(u => u.LastActiveAt >= DateTime.UtcNow.AddDays(-7))}\n\n";

                // –†–∞—Å—á–µ—Ç KPI –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                var userKpis = new List<(string Username, decimal Kpi, int CompletedTasks, int TotalTasks)>();

                foreach (var user in users.Take(10))
                {
                    var userTasks = tasks.Where(t => t.AssignedToUserId == user.TelegramId).ToList();
                    var completedTasks = userTasks.Count(t => t.Status == TeamTaskStatus.Completed);
                    var totalTasks = userTasks.Count;
                    var taskCompletionRate = totalTasks > 0 ? (decimal)completedTasks / totalTasks * 100 : 0;

                    // –§–æ—Ä–º—É–ª–∞ KPI: 70% –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á + 30% –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                    var activityScore = user.LastActiveAt >= DateTime.UtcNow.AddDays(-1) ? 100 :
                                       user.LastActiveAt >= DateTime.UtcNow.AddDays(-3) ? 70 :
                                       user.LastActiveAt >= DateTime.UtcNow.AddDays(-7) ? 40 : 10;

                    var kpi = taskCompletionRate * 0.7m + activityScore * 0.3m;
                    userKpis.Add((user.Username, kpi, completedTasks, totalTasks));
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5
                if (userKpis.Any())
                {
                    text += $"üèÜ –¢–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:\n";
                    userKpis = userKpis.OrderByDescending(x => x.Kpi).Take(5).ToList();

                    int rank = 1;
                    foreach (var userKpi in userKpis)
                    {
                        var rankIcon = rank == 1 ? "ü•á" : rank == 2 ? "ü•à" : rank == 3 ? "ü•â" : "‚Ä¢";
                        text += $"{rankIcon} @{userKpi.Username}: {(userKpi.Kpi):F1}/100\n";
                        if (userKpi.TotalTasks > 0)
                        {
                            var completionRate = (decimal)userKpi.CompletedTasks / userKpi.TotalTasks * 100;
                            text += $"   –ó–∞–¥–∞—á–∏: {userKpi.CompletedTasks}/{userKpi.TotalTasks} ({(completionRate):F1}%)\n";
                        }
                        rank++;
                    }

                    // –°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
                    var averageKpi = userKpis.Any() ? userKpis.Average(u => u.Kpi) : 0;
                    var activeUsers = users.Count(u => u.LastActiveAt >= DateTime.UtcNow.AddDays(-7));
                    var activePercentage = users.Count > 0 ? (decimal)activeUsers / users.Count * 100 : 0;

                    text += $"\nüìà –°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∫–æ–º–∞–Ω–¥—ã:\n";
                    text += $"‚Ä¢ –°—Ä–µ–¥–Ω–∏–π KPI: {(averageKpi):F1}/100\n";
                    text += $"‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {activeUsers}/{users.Count} ({(activePercentage):F1}%)\n";
                }
                else
                {
                    text += "üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ KPI —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.\n";
                }

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    MainMenuKeyboard.GetBackButton(CallbackData.BackToKpi),
                    "kpi_team",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing KPI team");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ KPI –∫–æ–º–∞–Ω–¥—ã.", cancellationToken);
            }
        }

        private string GetDayName(DayOfWeek day)
        {
            return day switch
            {
                DayOfWeek.Monday => "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
                DayOfWeek.Tuesday => "–í—Ç–æ—Ä–Ω–∏–∫",
                DayOfWeek.Wednesday => "–°—Ä–µ–¥–∞",
                DayOfWeek.Thursday => "–ß–µ—Ç–≤–µ—Ä–≥",
                DayOfWeek.Friday => "–ü—è—Ç–Ω–∏—Ü–∞",
                DayOfWeek.Saturday => "–°—É–±–±–æ—Ç–∞",
                DayOfWeek.Sunday => "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ",
                _ => day.ToString()
            };
        }
        #endregion

        #region –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleDatabaseCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case CallbackData.ContactsMenu:
                    await ShowContactsDatabaseAsync(chatId, cancellationToken);
                    break;

                case CallbackData.DropsMenu:
                    await ShowDropsDatabaseAsync(chatId, cancellationToken);
                    break;

                case CallbackData.ManualsMenu:
                    await ShowManualsDatabaseAsync(chatId, cancellationToken);
                    break;

                case CallbackData.ReportsMenu:
                    await ShowReportsDatabaseAsync(chatId, cancellationToken);
                    break;

                case CallbackData.ProjectDocsMenu:
                    await ShowProjectDocsDatabaseAsync(chatId, cancellationToken);
                    break;

                case CallbackData.AdDocsMenu:
                    await ShowAdDocsDatabaseAsync(chatId, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.", cancellationToken);
                    break;
            }
        }

        private async Task ShowContactsDatabaseAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var contacts = await _contactService.GetAllContactsAsync();

                var text = $"üë• –ë–∞–∑–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤\n\n" +
                           $"–í—Å–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: {contacts.Count}\n\n" +
                           $"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n";

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                var contactTypes = contacts
                    .GroupBy(c => c.ContactType ?? "–î–æ–ø")
                    .Select(g => new { Type = g.Key, Count = g.Count() })
                    .OrderByDescending(x => x.Count)
                    .Take(5)
                    .ToList();

                foreach (var type in contactTypes)
                {
                    var percentage = contacts.Count > 0 ? (decimal)type.Count / contacts.Count * 100 : 0;
                    text += $"‚Ä¢ {type.Type}: {type.Count} ({(percentage):F1}%)\n";
                }

                // –ù–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
                var recentContacts = contacts
                    .OrderByDescending(c => c.CreatedAt)
                    .Take(5)
                    .ToList();

                if (recentContacts.Any())
                {
                    text += $"\nüî• –ù–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ:\n";
                    foreach (var contact in recentContacts)
                    {
                        var daysAgo = (DateTime.UtcNow - contact.CreatedAt).Days;
                        var timeText = daysAgo == 0 ? "—Å–µ–≥–æ–¥–Ω—è" : $"{daysAgo} –¥–Ω. –Ω–∞–∑–∞–¥";
                        text += $"‚Ä¢ @{contact.TelegramUsername} - {timeText}\n";
                    }
                }

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üìã –í–µ—Å—å —Å–ø–∏—Å–æ–∫", CallbackData.ContactsList) },
            new() { InlineKeyboardButton.WithCallbackData("üîç –ü–æ–∏—Å–∫", CallbackData.ContactsSearch) },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToDatabase) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "database_contacts",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing contacts database");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–∑—ã –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.", cancellationToken);
            }
        }

        private async Task ShowDropsDatabaseAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –¥—Ä–æ–ø–∞—Ö –∏–∑ –ë–î
                // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É —Å —Ä–µ–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
                var projects = await _projectService.GetAllProjectsAsync();

                var completedProjects = projects.Count(p => p.Status == ProjectStatus.Completed);
                var totalProjects = projects.Count;
                var completionRate = totalProjects > 0 ? (decimal)completedProjects / totalProjects * 100 : 0;

                var text = $"üì¶ –ë–∞–∑–∞ –¥—Ä–æ–ø–æ–≤ (–ø—Ä–æ–µ–∫—Ç–æ–≤)\n\n" +
                           $"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤-–¥—Ä–æ–ø–æ–≤:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {totalProjects}\n" +
                           $"‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: {completedProjects} ({(completionRate):F1}%)\n" +
                           $"‚Ä¢ –í —Ä–∞–±–æ—Ç–µ: {projects.Count(p => p.Status == ProjectStatus.InProgress)}\n" +
                           $"‚Ä¢ –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç: {projects.Count(p => p.Status == ProjectStatus.Pending)}\n\n";

                // –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã (–¥—Ä–æ–ø—ã)
                var activeProjects = projects
                    .Where(p => p.Status == ProjectStatus.InProgress)
                    .Take(3)
                    .ToList();

                if (activeProjects.Any())
                {
                    text += $"üî• –ê–∫—Ç–∏–≤–Ω—ã–µ –¥—Ä–æ–ø—ã:\n";
                    foreach (var project in activeProjects)
                    {
                        var tasksCount = project.Tasks?.Count ?? 0;
                        var completedTasks = project.Tasks?.Count(t => t.Status == TeamTaskStatus.Completed) ?? 0;
                        var progress = tasksCount > 0 ? (decimal)completedTasks / tasksCount * 100 : 0;

                        text += $"‚Ä¢ {project.Name} - {progress:F1}% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ\n";
                    }
                }

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üìã –°–ø–∏—Å–æ–∫ –¥—Ä–æ–ø–æ–≤", CallbackData.ProjectsList) },
            new() { InlineKeyboardButton.WithCallbackData("‚ûï –ù–æ–≤—ã–π –¥—Ä–æ–ø", CallbackData.CreateProject) },
            new() { InlineKeyboardButton.WithCallbackData("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "drops_stats") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToDatabase) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "database_drops",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing drops database");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–∑—ã –¥—Ä–æ–ø–æ–≤.", cancellationToken);
            }
        }

        private async Task ShowManualsDatabaseAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
                var projects = await _projectService.GetAllProjectsAsync();
                var projectsWithDocs = projects
                    .Where(p => !string.IsNullOrEmpty(p.Description) || !string.IsNullOrEmpty(p.Link))
                    .Take(5)
                    .ToList();

                var text = $"üìñ –ë–∞–∑–∞ –º–∞–Ω—É–∞–ª–æ–≤\n\n" +
                           $"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {projects.Count}\n" +
                           $"‚Ä¢ –° –æ–ø–∏—Å–∞–Ω–∏–µ–º: {projects.Count(p => !string.IsNullOrEmpty(p.Description))}\n" +
                           $"‚Ä¢ –°–æ —Å—Å—ã–ª–∫–∞–º–∏: {projects.Count(p => !string.IsNullOrEmpty(p.Link))}\n\n";

                if (projectsWithDocs.Any())
                {
                    text += $"üìÅ –ü—Ä–æ–µ–∫—Ç—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π:\n";
                    foreach (var project in projectsWithDocs)
                    {
                        var hasDescription = !string.IsNullOrEmpty(project.Description) ? "üìù" : "";
                        var hasLink = !string.IsNullOrEmpty(project.Link) ? "üîó" : "";
                        text += $"‚Ä¢ {project.Name} {hasDescription}{hasLink}\n";
                    }
                }
                else
                {
                    text += "üì≠ –ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.\n";
                }

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üìã –°–ø–∏—Å–æ–∫ –º–∞–Ω—É–∞–ª–æ–≤", CallbackData.ProjectsList) },
            new() { InlineKeyboardButton.WithCallbackData("üîç –ü–æ–∏—Å–∫", "manuals_search") },
            new() { InlineKeyboardButton.WithCallbackData("üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏", "manuals_categories") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToDatabase) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "database_manuals",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing manuals database");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–∑—ã –º–∞–Ω—É–∞–ª–æ–≤.", cancellationToken);
            }
        }

        private async Task ShowReportsDatabaseAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç—á–µ—Ç–æ–≤
                var projects = await _projectService.GetAllProjectsAsync();
                var tasks = await _taskService.GetAllTasksAsync();
                var financeRecords = await _financeService.GetAllRecordsAsync();

                var monthStart = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
                var monthProjects = projects.Count(p => p.CreatedAt >= monthStart);
                var monthTasks = tasks.Count(t => t.CreatedAt >= monthStart);
                var monthFinance = financeRecords.Count(f => f.TransactionDate >= monthStart);

                var text = $"üìä –ë–∞–∑–∞ –æ—Ç—á–µ—Ç–æ–≤\n\n" +
                           $"üìÖ –ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü ({monthStart:MMMM yyyy}):\n" +
                           $"‚Ä¢ –ù–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤: {monthProjects}\n" +
                           $"‚Ä¢ –ù–æ–≤—ã—Ö –∑–∞–¥–∞—á: {monthTasks}\n" +
                           $"‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π: {monthFinance}\n\n" +
                           $"üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {projects.Count}\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –∑–∞–¥–∞—á: {tasks.Count}\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π: {financeRecords.Count}\n\n" +
                           $"üíæ –¢–∏–ø—ã –æ—Ç—á–µ—Ç–æ–≤:\n" +
                           $"‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã\n" +
                           $"‚Ä¢ –û—Ç—á–µ—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º\n" +
                           $"‚Ä¢ –û—Ç—á–µ—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º\n" +
                           $"‚Ä¢ KPI –æ—Ç—á–µ—Ç—ã";

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üìÖ –û—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü", "reports_month") },
            new() { InlineKeyboardButton.WithCallbackData("üìä KPI –æ—Ç—á–µ—Ç", CallbackData.KpiOverall) },
            new() { InlineKeyboardButton.WithCallbackData("üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö", "reports_export") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToDatabase) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "database_reports",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing reports database");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–∑—ã –æ—Ç—á–µ—Ç–æ–≤.", cancellationToken);
            }
        }

        private async Task ShowProjectDocsDatabaseAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                var projects = await _projectService.GetAllProjectsAsync();

                var text = $"üìã –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤\n\n" +
                           $"–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {projects.Count}\n\n" +
                           $"üìÅ –ü—Ä–æ–µ–∫—Ç—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π:\n";

                var projectsWithDocs = projects
                    .Where(p => !string.IsNullOrEmpty(p.Description) || !string.IsNullOrEmpty(p.Link))
                    .Take(5)
                    .ToList();

                foreach (var project in projectsWithDocs)
                {
                    var hasDescription = !string.IsNullOrEmpty(project.Description) ? "üìù" : "";
                    var hasLink = !string.IsNullOrEmpty(project.Link) ? "üîó" : "";
                    var statusIcon = project.Status switch
                    {
                        ProjectStatus.Pending => "üü°",
                        ProjectStatus.InProgress => "üü†",
                        ProjectStatus.Completed => "‚úÖ",
                        _ => "‚ö™"
                    };

                    text += $"{statusIcon} {project.Name} {hasDescription}{hasLink}\n";
                }

                if (projectsWithDocs.Count == 0)
                {
                    text += "üì≠ –ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.\n";
                }

                var statsText = $"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n" +
                                $"‚Ä¢ –° –æ–ø–∏—Å–∞–Ω–∏–µ–º: {projects.Count(p => !string.IsNullOrEmpty(p.Description))}\n" +
                                $"‚Ä¢ –°–æ —Å—Å—ã–ª–∫–∞–º–∏: {projects.Count(p => !string.IsNullOrEmpty(p.Link))}\n" +
                                $"‚Ä¢ –ü–æ–ª–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è: {projects.Count(p => !string.IsNullOrEmpty(p.Description) && p.Description.Length > 100)}";

                text += statsText;

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üìã –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤", CallbackData.ProjectsList) },
            new() { InlineKeyboardButton.WithCallbackData("üîç –ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏", "project_docs_search") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToDatabase) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "database_project_docs",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing project docs database");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤.", cancellationToken);
            }
        }

        private async Task ShowAdDocsDatabaseAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ —Å —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
                var financeRecords = await _financeService.GetAllRecordsAsync();
                var advertisingExpenses = financeRecords
                    .Where(f => f.Type == FinancialRecordType.Expense &&
                               (f.Category.Contains("–†–µ–∫–ª–∞–º–∞") || f.Category.Contains("–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥")))
                    .ToList();

                var totalAdvertising = advertisingExpenses.Sum(f => f.Amount);
                var monthAdvertising = advertisingExpenses
                    .Where(f => f.TransactionDate.Month == DateTime.UtcNow.Month)
                    .Sum(f => f.Amount);

                var text = $"üì¢ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–µ–∫–ª–∞–º–µ\n\n" +
                           $"üí∞ –†–µ–∫–ª–∞–º–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: {totalAdvertising:N2} USD\n" +
                           $"‚Ä¢ –ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: {monthAdvertising:N2} USD\n" +
                           $"‚Ä¢ –°—Ä–µ–¥–Ω–µ–º–µ—Å—è—á–Ω—ã–µ: {(totalAdvertising / Math.Max(1, advertisingExpenses.GroupBy(f => new { f.TransactionDate.Year, f.TransactionDate.Month }).Count())):N2} USD\n\n";

                // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
                var adCategories = advertisingExpenses
                    .GroupBy(f => f.Category)
                    .Select(g => new { Category = g.Key, Amount = g.Sum(f => f.Amount) })
                    .OrderByDescending(x => x.Amount)
                    .Take(3)
                    .ToList();

                if (adCategories.Any())
                {
                    text += $"üìä –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π:\n";
                    foreach (var category in adCategories)
                    {
                        var percentage = totalAdvertising > 0 ? category.Amount / totalAdvertising * 100 : 0;
                        text += $"‚Ä¢ {category.Category}: {category.Amount:N2} USD ({(percentage):F1}%)\n";
                    }
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑—å —Å —Ä–µ–∫–ª–∞–º–æ–π)
                var projects = await _projectService.GetAllProjectsAsync();
                var activeProjects = projects.Count(p => p.Status == ProjectStatus.InProgress);

                text += $"\nüéØ –†–µ–∫–ª–∞–º–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:\n" +
                        $"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤: {activeProjects}\n" +
                        $"‚Ä¢ –†–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π: {advertisingExpenses.Count}\n" +
                        $"‚Ä¢ –°—Ä–µ–¥–Ω–∏–π –±—é–¥–∂–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏: {(advertisingExpenses.Any() ? advertisingExpenses.Average(f => f.Amount) : 0):N2} USD";

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("üìã –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω—ã", CallbackData.AdContentPlan) },
            new() { InlineKeyboardButton.WithCallbackData("üì¢ –†–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏", CallbackData.AdCampaignPlan) },
            new() { InlineKeyboardButton.WithCallbackData("üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞", "ad_analytics") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToDatabase) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "database_ad_docs",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing ad docs database");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ —Ä–µ–∫–ª–∞–º–µ.", cancellationToken);
            }
        }
        #endregion

        #region –†–µ–∫–ª–∞–º–∞ - –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
        private async Task HandleAdvertisementCallbackAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case CallbackData.AdContentPlan:
                    await ShowContentPlanMenuAsync(chatId, userId, cancellationToken);
                    break;

                case CallbackData.AdCampaignPlan:
                    await ShowCampaignPlanMenuAsync(chatId, userId, cancellationToken);
                    break;

                default:
                    if (callbackData.StartsWith("content_plan_"))
                    {
                        await HandleContentPlanActionAsync(chatId, userId, callbackData, cancellationToken);
                    }
                    else if (callbackData.StartsWith("campaign_"))
                    {
                        await HandleCampaignActionAsync(chatId, userId, callbackData, cancellationToken);
                    }
                    break;
            }
        }

        private async Task ShowContentPlanMenuAsync(long chatId, long userId, CancellationToken cancellationToken)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞
                var projects = await _projectService.GetAllProjectsAsync();
                var activeProjects = projects.Where(p => p.Status == ProjectStatus.InProgress).Take(3).ToList();

                var text = $"# –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω\n\n" +
                           $"üìä –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {activeProjects.Count}\n\n";

                if (activeProjects.Any())
                {
                    text += $"üéØ –¢–µ–º—ã –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞:\n";
                    foreach (var project in activeProjects)
                    {
                        var tasksCount = project.Tasks?.Count ?? 0;
                        text += $"‚Ä¢ {project.Name} ({tasksCount} –∑–∞–¥–∞—á)\n";
                    }
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞—á–∞–º (–∫–∞–∫ –∫–æ–Ω—Ç–µ–Ω—Ç)
                var tasks = await _taskService.GetAllTasksAsync();
                var recentTasks = tasks
                    .Where(t => t.CreatedAt >= DateTime.UtcNow.AddDays(-7))
                    .Take(5)
                    .ToList();

                if (recentTasks.Any())
                {
                    text += $"\nüìù –ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–∏–¥–µ–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞):\n";
                    foreach (var task in recentTasks)
                    {
                        text += $"‚Ä¢ {task.Title}\n";
                    }
                }

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("‚ûï –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω", "content_plan_create") },
            new() { InlineKeyboardButton.WithCallbackData("üìã –ú–æ–∏ –ø–ª–∞–Ω—ã", "content_plan_list") },
            new() { InlineKeyboardButton.WithCallbackData("üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞", "content_plan_analytics") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToAdvertisement) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "content_plan_menu",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing content plan menu");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞.", cancellationToken);
            }
        }

        private async Task ShowCampaignPlanMenuAsync(long chatId, long userId, CancellationToken cancellationToken)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π
                var financeRecords = await _financeService.GetAllRecordsAsync();
                var advertisingExpenses = financeRecords
                    .Where(f => f.Type == FinancialRecordType.Expense &&
                               (f.Category.Contains("–†–µ–∫–ª–∞–º–∞") || f.Category.Contains("–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥")))
                    .ToList();

                var totalAdvertising = advertisingExpenses.Sum(f => f.Amount);
                var monthStart = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
                var monthAdvertising = advertisingExpenses
                    .Where(f => f.TransactionDate >= monthStart)
                    .Sum(f => f.Amount);

                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Ö–æ–¥—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ ROI
                var incomes = await _financeService.GetRecordsByTypeAsync(FinancialRecordType.Income);
                var monthIncomes = incomes
                    .Where(i => i.TransactionDate >= monthStart)
                    .Sum(i => i.Amount);

                var roi = monthAdvertising > 0 ? (monthIncomes / monthAdvertising * 100) - 100 : 0;

                var text = $"üì¢ –†–µ–∫–ª–∞–º–Ω—ã–π –ø–ª–∞–Ω\n\n" +
                           $"üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:\n" +
                           $"‚Ä¢ –í—Å–µ–≥–æ –Ω–∞ —Ä–µ–∫–ª–∞–º—É: {totalAdvertising:N2} USD\n" +
                           $"‚Ä¢ –ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: {monthAdvertising:N2} USD\n" +
                           $"‚Ä¢ –î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü: {monthIncomes:N2} USD\n" +
                           $"‚Ä¢ ROI: {(roi):F1}%\n\n" +
                           $"üìä –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:\n" +
                           $"‚Ä¢ –ö–∞–º–ø–∞–Ω–∏–π –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ: {advertisingExpenses.Count(f => f.TransactionDate >= monthStart)}\n" +
                           $"‚Ä¢ –°—Ä–µ–¥–Ω–∏–π –±—é–¥–∂–µ—Ç: {(advertisingExpenses.Any() ? advertisingExpenses.Average(f => f.Amount) : 0):N2} USD";

                var buttons = new List<List<InlineKeyboardButton>>
        {
            new() { InlineKeyboardButton.WithCallbackData("‚ûï –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é", "campaign_create") },
            new() { InlineKeyboardButton.WithCallbackData("üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏", "campaign_list_active") },
            new() { InlineKeyboardButton.WithCallbackData("üìä –û—Ç—á–µ—Ç—ã", "campaign_reports") },
            new() { InlineKeyboardButton.WithCallbackData("‚óÄÔ∏è –ù–∞–∑–∞–¥", CallbackData.BackToAdvertisement) }
        };

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    new InlineKeyboardMarkup(buttons),
                    "campaign_plan_menu",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing campaign plan menu");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –ø–ª–∞–Ω–∞.", cancellationToken);
            }
        }

        private async Task HandleContentPlanActionAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case "content_plan_create":
                    _userStates[userId] = new UserState
                    {
                        CurrentAction = "create_content_plan",
                        Step = 1
                    };
                    await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞:", cancellationToken);
                    break;

                case "content_plan_list":
                    await ShowContentPlansListAsync(chatId, userId, cancellationToken);
                    break;

                case "content_plan_analytics":
                    await ShowContentAnalyticsAsync(chatId, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.", cancellationToken);
                    break;
            }
        }

        private async Task HandleCampaignActionAsync(long chatId, long userId, string callbackData, CancellationToken cancellationToken)
        {
            switch (callbackData)
            {
                case "campaign_create":
                    _userStates[userId] = new UserState
                    {
                        CurrentAction = "create_campaign",
                        Step = 1
                    };
                    await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏:", cancellationToken);
                    break;

                case "campaign_list_active":
                    await ShowActiveCampaignsAsync(chatId, cancellationToken);
                    break;

                default:
                    await SendTemporaryMessageAsync(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.", cancellationToken);
                    break;
            }
        }

        private async Task ShowContentPlansListAsync(long chatId, long userId, CancellationToken cancellationToken)
        {
            try
            {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω—ã –∏–∑ –ë–î
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –∫–∞–∫ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω—ã
                var projects = await _projectService.GetAllProjectsAsync();
                var recentProjects = projects
                    .OrderByDescending(p => p.CreatedAt)
                    .Take(3)
                    .ToList();

                var text = $"üìã –ú–æ–∏ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω—ã (–ø—Ä–æ–µ–∫—Ç—ã)\n\n";

                if (recentProjects.Any())
                {
                    foreach (var project in recentProjects)
                    {
                        var statusIcon = project.Status switch
                        {
                            ProjectStatus.Pending => "üü°",
                            ProjectStatus.InProgress => "üü†",
                            ProjectStatus.Completed => "‚úÖ",
                            _ => "‚ö™"
                        };

                        var daysAgo = (DateTime.UtcNow - project.CreatedAt).Days;
                        var timeText = daysAgo == 0 ? "—Å–µ–≥–æ–¥–Ω—è" : $"{daysAgo} –¥–Ω. –Ω–∞–∑–∞–¥";

                        text += $"{statusIcon} {project.Name}\n";
                        text += $"   ‚Ä¢ –°–æ–∑–¥–∞–Ω: {timeText}\n";
                        text += $"   ‚Ä¢ –°—Ç–∞—Ç—É—Å: {project.Status}\n";
                        text += $"   ‚Ä¢ –ó–∞–¥–∞—á: {project.Tasks?.Count ?? 0}\n\n";
                    }
                }
                else
                {
                    text += "üì≠ –ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–æ–≤.\n";
                }

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    MainMenuKeyboard.GetBackButton("content_plan_menu"),
                    "content_plans_list",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing content plans list");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–æ–≤.", cancellationToken);
            }
        }

        private async Task ShowContentAnalyticsAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∑–∞–¥–∞—á
                var projects = await _projectService.GetAllProjectsAsync();
                var tasks = await _taskService.GetAllTasksAsync();

                var weekStart = DateTime.UtcNow.AddDays(-7);
                var weekTasks = tasks.Count(t => t.CreatedAt >= weekStart);
                var weekCompleted = tasks.Count(t => t.Status == TeamTaskStatus.Completed && t.CompletedAt >= weekStart);

                var completionRate = weekTasks > 0 ? (decimal)weekCompleted / weekTasks * 100 : 0;

                var text = $"üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞\n\n" +
                           $"üìÖ –ó–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é:\n" +
                           $"‚Ä¢ –ù–æ–≤—ã—Ö –∑–∞–¥–∞—á: {weekTasks}\n" +
                           $"‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á: {weekCompleted}\n" +
                           $"‚Ä¢ –ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {(completionRate):F1}%\n\n" +
                           $"üìà –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã:\n";

                var activeProjects = projects
                    .Where(p => p.Status == ProjectStatus.InProgress)
                    .Take(3)
                    .ToList();

                if (activeProjects.Any())
                {
                    foreach (var project in activeProjects)
                    {
                        var projectTasks = project.Tasks?.Count ?? 0;
                        var completedTasks = project.Tasks?.Count(t => t.Status == TeamTaskStatus.Completed) ?? 0;
                        var progress = projectTasks > 0 ? (decimal)completedTasks / projectTasks * 100 : 0;

                        text += $"‚Ä¢ {project.Name}: {progress:F1}% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ\n";
                    }
                }

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    MainMenuKeyboard.GetBackButton("content_plan_menu"),
                    "content_analytics",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing content analytics");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.", cancellationToken);
            }
        }

        private async Task ShowActiveCampaignsAsync(long chatId, CancellationToken cancellationToken)
        {
            try
            {
                // –ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ - –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
                var financeRecords = await _financeService.GetAllRecordsAsync();
                var monthStart = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);

                var advertisingExpenses = financeRecords
                    .Where(f => f.Type == FinancialRecordType.Expense &&
                               (f.Category.Contains("–†–µ–∫–ª–∞–º–∞") || f.Category.Contains("–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥")) &&
                               f.TransactionDate >= monthStart)
                    .OrderByDescending(f => f.Amount)
                    .Take(3)
                    .ToList();

                var text = $"üì¢ –ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏\n\n" +
                           $"üìÖ –ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:\n\n";

                if (advertisingExpenses.Any())
                {
                    int index = 1;
                    foreach (var record in advertisingExpenses)
                    {
                        var daysAgo = (DateTime.UtcNow - record.TransactionDate).Days;
                        var timeText = daysAgo == 0 ? "—Å–µ–≥–æ–¥–Ω—è" : $"{daysAgo} –¥–Ω. –Ω–∞–∑–∞–¥";

                        text += $"{index}. {record.Description}\n";
                        text += $"   ‚Ä¢ –ë—é–¥–∂–µ—Ç: {record.Amount:N2} USD\n";
                        text += $"   ‚Ä¢ –î–∞—Ç–∞: {timeText}\n";
                        text += $"   ‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {record.Category}\n\n";
                        index++;
                    }
                }
                else
                {
                    text += "üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ.\n";
                }

                // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                var totalAdvertising = advertisingExpenses.Sum(f => f.Amount);
                text += $"üí∞ –û–±—â–∏–π –±—é–¥–∂–µ—Ç: {totalAdvertising:N2} USD\n";
                text += $"üìä –°—Ä–µ–¥–Ω–∏–π –±—é–¥–∂–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏: {(advertisingExpenses.Any() ? advertisingExpenses.Average(f => f.Amount) : 0):N2} USD";

                await _menuManager.ShowInlineMenuAsync(
                    chatId,
                    text,
                    MainMenuKeyboard.GetBackButton("campaign_plan_menu"),
                    "active_campaigns",
                    cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error showing active campaigns");
                await SendTemporaryMessageAsync(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π.", cancellationToken);
            }
        }
        #endregion

        #region –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        private async Task SendTemporaryMessageAsync(long chatId, string text, CancellationToken cancellationToken)
        {
            try
            {
                await _botClient.SendMessage(
                    chatId: chatId,
                    text: text,
                    cancellationToken: cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in SendTemporaryMessageAsync for chat {ChatId}", chatId);
            }
        }

        private async Task HandleAddIncomeStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (state.Step == 1)
            {
                if (!decimal.TryParse(text, out decimal amount) || amount <= 0)
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0):", cancellationToken);
                    return;
                }

                state.Data["amount"] = amount;
                state.Step = 2;
                _userStates[userId] = state; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Ö–æ–¥–∞:", cancellationToken);
            }
            else if (state.Step == 2)
            {
                var amount = (decimal)state.Data["amount"]!;
                var category = state.Data["category"]?.ToString() ?? "–ü—Ä–æ—á–µ–µ";

                var record = await _financeService.CreateFinancialRecordAsync(
                    type: FinancialRecordType.Income,
                    category: category,
                    description: text,
                    amount: amount,
                    currency: "USD",
                    source: null,
                    userId: userId,
                    projectId: null);

                if (record != null)
                {
                    await SendTemporaryMessageAsync(chatId,
                        $"‚úÖ –î–æ—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!\nüí∞ {amount:N2} USD - {text}\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}",
                        cancellationToken);

                    _userStates.Remove(userId); // –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    await _menuManager.ShowFinanceMenuAsync(chatId, cancellationToken);
                }
                else
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥.", cancellationToken);
                    _userStates.Remove(userId); // –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                }
            }
        }

        private async Task HandleAddExpenseStateAsync(long chatId, long userId, string text, UserState state, CancellationToken cancellationToken)
        {
            if (state.Step == 1)
            {
                if (!decimal.TryParse(text, out decimal amount) || amount <= 0)
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0):", cancellationToken);
                    return;
                }

                state.Data["amount"] = amount;
                state.Step = 2;
                _userStates[userId] = state; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                await SendTemporaryMessageAsync(chatId, "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞:", cancellationToken);
            }
            else if (state.Step == 2)
            {
                var amount = (decimal)state.Data["amount"]!;
                var category = state.Data["category"]?.ToString() ?? "–ü—Ä–æ—á–µ–µ";

                var record = await _financeService.CreateFinancialRecordAsync(
                    type: FinancialRecordType.Expense,
                    category: category,
                    description: text,
                    amount: amount,
                    currency: "USD",
                    source: null,
                    userId: userId,
                    projectId: null);

                if (record != null)
                {
                    await SendTemporaryMessageAsync(chatId,
                        $"‚úÖ –†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!\nüí∏ {amount:N2} USD - {text}\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}",
                        cancellationToken);

                    _userStates.Remove(userId); // –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    await _menuManager.ShowFinanceMenuAsync(chatId, cancellationToken);
                }
                else
                {
                    await SendTemporaryMessageAsync(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥.", cancellationToken);
                    _userStates.Remove(userId); // –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                }
            }
        }
        #endregion
    }
}
