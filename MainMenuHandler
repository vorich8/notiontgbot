using Microsoft.Extensions.Logging;
using Telegram.Bot;
using Telegram.Bot.Types;
using TeamManagerBot.Services;

namespace TeamManagerBot.Handlers
{
    public class MainMenuHandler
    {
        private readonly ITelegramBotClient _botClient;
        private readonly IUserService _userService;
        private readonly ILogger<MainMenuHandler> _logger;
        private readonly MenuManager _menuManager;

        public MainMenuHandler(
            ITelegramBotClient botClient,
            IUserService userService,
            ILogger<MainMenuHandler> logger,
            MenuManager menuManager)
        {
            _botClient = botClient;
            _userService = userService;
            _logger = logger;
            _menuManager = menuManager;
        }

        public async Task HandleStartCommandAsync(Message message, CancellationToken cancellationToken)
        {
            try
            {
                var user = await _userService.GetOrCreateUserAsync(
                    message.From!.Id,
                    message.From.Username ?? "unknown",
                    message.From.FirstName,
                    message.From.LastName);

                if (user == null)
                {
                    await SendTemporaryMessageAsync(message.Chat.Id,
                        "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                        cancellationToken);
                    return;
                }

                var isAdmin = await _userService.IsAdminAsync(user.TelegramId);
                await _menuManager.ShowMainMenuAsync(message.Chat.Id, user.TelegramId, isAdmin, cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in HandleStartCommandAsync");
                await SendTemporaryMessageAsync(message.Chat.Id,
                    "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã.",
                    cancellationToken);
            }
        }

        public async Task HandleMainMenuSelectionAsync(Message message, CancellationToken cancellationToken)
        {
            var text = message.Text ?? string.Empty;
            var chatId = message.Chat.Id;
            var userId = message.From!.Id;

            try
            {
                var isAdmin = await _userService.IsAdminAsync(userId);
                await _userService.UpdateUserLastActiveAsync(userId);

                switch (text)
                {
                    case "üìÇ –ü—Ä–æ–µ–∫—Ç—ã":
                        await _menuManager.ShowProjectsMenuAsync(chatId, cancellationToken);
                        break;

                    case "‚úÖ –ó–∞–¥–∞—á–∏":
                        await _menuManager.ShowTasksMenuAsync(chatId, isAdmin, cancellationToken);
                        break;

                    case "üìä –°—Ç–∞—Ç—É—Å—ã":
                        await _menuManager.ShowStatusesMenuAsync(chatId, cancellationToken);
                        break;

                    case "üì¢ –†–µ–∫–ª–∞–º–∞":
                        await _menuManager.ShowAdvertisementMenuAsync(chatId, cancellationToken);
                        break;

                    case "üë§ –ö–æ–Ω—Ç–∞–∫—Ç—ã":
                        await _menuManager.ShowContactsMenuAsync(chatId, cancellationToken);
                        break;

                    case "üóÉÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö":
                        await _menuManager.ShowDatabaseMenuAsync(chatId, cancellationToken);
                        break;

                    case "üí∞ –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è":
                        await _menuManager.ShowFinanceMenuAsync(chatId, cancellationToken);
                        break;

                    case "üìà KPI":
                        await _menuManager.ShowKPIMenuAsync(chatId, cancellationToken);
                        break;

                    case "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏":
                        if (isAdmin)
                        {
                            await _menuManager.ShowSettingsMenuAsync(chatId, cancellationToken);
                        }
                        else
                        {
                            await SendTemporaryMessageAsync(chatId,
                                "‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.",
                                cancellationToken);
                        }
                        break;

                    case "‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
                        await _menuManager.ShowMainMenuAsync(chatId, userId, isAdmin, cancellationToken);
                        break;

                    default:
                        // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                        break;
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in HandleMainMenuSelectionAsync for chat {ChatId}", chatId);
                await SendTemporaryMessageAsync(chatId,
                    "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.",
                    cancellationToken);
            }
        }

        private async Task SendTemporaryMessageAsync(
            long chatId,
            string text,
            CancellationToken cancellationToken)
        {
            try
            {
                await _botClient.SendMessage(
                    chatId: chatId,
                    text: text,
                    cancellationToken: cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in SendTemporaryMessageAsync for chat {ChatId}", chatId);
            }
        }
    }
}
