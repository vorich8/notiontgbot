// Program.cs
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using TeamManagerBot.Handlers;
using TeamManagerBot.Models;
using TeamManagerBot.Services;
using Telegram.Bot;
using Telegram.Bot.Polling;
using Telegram.Bot.Types.Enums;

namespace TeamManagerBot
{
    class Program
    {
        private static IHost? _host;
        private static ILogger<Program>? _logger;
        private static CancellationTokenSource _cts = new();

        static async Task Main(string[] args)
        {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Ctrl+C
            Console.CancelKeyPress += (sender, e) =>
            {
                Console.WriteLine("\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...");
                _cts.Cancel();
                e.Cancel = true;
            };

            try
            {
                Console.WriteLine("üöÄ –ó–∞–ø—É—Å–∫ Team Manager Bot...");
                Console.WriteLine("=".PadRight(50, '='));

                // –°–æ–∑–¥–∞–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ö–æ—Å—Ç
                _host = Host.CreateDefaultBuilder(args)
                    .ConfigureServices((context, services) =>
                    {
                        ConfigureServices(services, context.Configuration);
                    })
                    .Build();

                // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–≥–µ—Ä
                _logger = _host.Services.GetRequiredService<ILogger<Program>>();

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–ü–ï–†–ï–î –∑–∞–ø—É—Å–∫–æ–º —Ö–æ—Å—Ç–∞!)
                await InitializeDatabaseAsync();

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
                await RunBotAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {ex.Message}");
                Console.WriteLine(ex.StackTrace);
                if (_logger != null)
                {
                    _logger.LogCritical(ex, "Critical error during bot startup");
                }
            }
            finally
            {
                Console.WriteLine("\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...");
                await (_host?.StopAsync() ?? Task.CompletedTask);
                _host?.Dispose();
            }
        }

        private static void ConfigureServices(IServiceCollection services, IConfiguration configuration)
        {
            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
            services.AddLogging(configure =>
            {
                configure.AddConsole();
                configure.AddDebug();
                configure.SetMinimumLevel(LogLevel.Information);
                configure.AddFilter("Microsoft.EntityFrameworkCore.Database.Command", LogLevel.Warning);
            });

            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
            services.AddSingleton(configuration);

            // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –í–ê–ñ–ù–û: ConnectionString
            var connectionString = configuration["BotConfiguration:ConnectionString"]
                ?? "Data Source=TeamManager.db;Cache=Shared";

            services.AddDbContext<ApplicationDbContext>(options =>
            {
                options.UseSqlite(connectionString);
                options.EnableSensitiveDataLogging(false);
                options.EnableDetailedErrors();
            });

            // Telegram Bot Client
            var botToken = configuration["BotConfiguration:BotToken"];
            if (string.IsNullOrEmpty(botToken))
            {
                throw new InvalidOperationException("Bot token is not configured. Please set BotConfiguration:BotToken in appsettings.json");
            }

            services.AddSingleton<ITelegramBotClient>(sp =>
            {
                var logger = sp.GetRequiredService<ILogger<Program>>();
                logger.LogInformation("Creating Telegram Bot Client...");
                return new TelegramBotClient(botToken);
            });

            // –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–µ–Ω—é (Singleton)
            services.AddSingleton<MenuStateManager>();

            // –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ–Ω—é (Singleton)
            services.AddSingleton<MenuManager>();

            // –°–µ—Ä–≤–∏—Å—ã (Scoped)
            services.AddScoped<IUserService, UserService>();
            services.AddScoped<IProjectService, ProjectService>();
            services.AddScoped<ITaskService, TaskService>();
            services.AddScoped<IFinanceService, FinanceService>();
            services.AddScoped<IContactService, ContactService>();
            services.AddScoped<IEncryptionService, EncryptionService>();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (Scoped)
            services.AddScoped<MainMenuHandler>();
            services.AddScoped<CallbackQueryHandler>();
            services.AddScoped<UpdateHandler>();

            // Polling Receiver
            services.AddSingleton<IUpdateHandler, UpdateHandler>();

            // Receiver Service
            services.AddHostedService<ReceiverService>();
        }

        private static async Task InitializeDatabaseAsync()
        {
            using var scope = _host!.Services.CreateScope();
            var dbContext = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
            var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();

            try
            {
                logger.LogInformation("Initializing database...");

                // –£–î–ê–õ–ò–¢–¨ –í–°–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –¢–ê–ë–õ–ò–¶–´ –ò –°–û–ó–î–ê–¢–¨ –ó–ê–ù–û–í–û
                // –≠—Ç–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏.

                // 1. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –±–∞–∑—É –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                try
                {
                    logger.LogInformation("Deleting old database if exists...");
                    await dbContext.Database.EnsureDeletedAsync();
                }
                catch (Exception ex)
                {
                    logger.LogWarning(ex, "Could not delete old database");
                }

                // 2. –°–û–ó–î–ê–ï–ú –ë–ê–ó–£ –î–ê–ù–ù–´–• –ò –í–°–ï –¢–ê–ë–õ–ò–¶–´
                logger.LogInformation("Creating database and tables...");
                var created = await dbContext.Database.EnsureCreatedAsync();

                if (created)
                {
                    logger.LogInformation("‚úÖ Database created successfully!");
                    Console.WriteLine("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!");
                }
                else
                {
                    logger.LogInformation("Database already exists");
                    Console.WriteLine("‚ÑπÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
                }

                // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
                var adminIds = _host.Services.GetRequiredService<IConfiguration>()
                    .GetSection("BotConfiguration:AdminIds").Get<long[]>() ?? Array.Empty<long>();

                var userService = scope.ServiceProvider.GetRequiredService<IUserService>();

                // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
                foreach (var adminId in adminIds)
                {
                    logger.LogInformation("Admin configured: {AdminId}", adminId);
                }

                // 4. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–µ—Å–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞)
                if (await dbContext.Users.CountAsync() == 0)
                {
                    logger.LogInformation("Creating test data...");
                    await CreateTestDataAsync(dbContext);
                    logger.LogInformation("‚úÖ Test data created successfully!");
                    Console.WriteLine("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!");
                }

                logger.LogInformation("‚úÖ Database initialized successfully");
                Console.WriteLine("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "‚ùå Error initializing database");
                Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {ex.Message}");

                // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –±–∞–∑—É –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–ø—ã—Ç–∫—É
                try
                {
                    logger.LogWarning("Trying to create database with simple approach...");
                    await dbContext.Database.EnsureCreatedAsync();
                    logger.LogWarning("Database created with simple approach");
                }
                catch (Exception fallbackEx)
                {
                    logger.LogCritical(fallbackEx, "Failed to create database even with fallback");
                    throw;
                }
            }
        }

        private static async Task CreateTestDataAsync(ApplicationDbContext dbContext)
        {
            try
            {
                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                var admin = new User
                {
                    TelegramId = 123456789,
                    Username = "testadmin",
                    FirstName = "Test",
                    LastName = "Admin",
                    Role = UserRole.Admin,
                    CreatedAt = DateTime.UtcNow,
                    LastActiveAt = DateTime.UtcNow
                };

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                var user = new User
                {
                    TelegramId = 987654321,
                    Username = "testuser",
                    FirstName = "Test",
                    LastName = "User",
                    Role = UserRole.Member,
                    CreatedAt = DateTime.UtcNow,
                    LastActiveAt = DateTime.UtcNow
                };

                dbContext.Users.Add(admin);
                dbContext.Users.Add(user);
                await dbContext.SaveChangesAsync();

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                var project = new Project
                {
                    Name = "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç",
                    Description = "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞",
                    Status = ProjectStatus.InProgress,
                    CreatedByUserId = admin.TelegramId,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };

                dbContext.Projects.Add(project);
                await dbContext.SaveChangesAsync();

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
                var tasks = new[]
                {
                    new TeamTask
                    {
                        Title = "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ",
                        Description = "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –ü–û",
                        Status = TeamTaskStatus.Active,
                        ProjectId = project.Id,
                        AssignedToUserId = user.TelegramId,
                        CreatedByUserId = admin.TelegramId,
                        DueDate = DateTime.UtcNow.AddDays(3),
                        CreatedAt = DateTime.UtcNow
                    },
                    new TeamTask
                    {
                        Title = "–°–æ–∑–¥–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö",
                        Description = "–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö",
                        Status = TeamTaskStatus.Completed,
                        ProjectId = project.Id,
                        AssignedToUserId = admin.TelegramId,
                        CreatedByUserId = admin.TelegramId,
                        CompletedAt = DateTime.UtcNow.AddDays(-1),
                        CreatedAt = DateTime.UtcNow.AddDays(-5)
                    }
                };

                dbContext.Tasks.AddRange(tasks);
                await dbContext.SaveChangesAsync();

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏
                var financialRecords = new[]
                {
                    new FinancialRecord
                    {
                        Type = FinancialRecordType.Income,
                        Category = "–ü—Ä–æ–¥–∞–∂–∏",
                        Description = "–ü—Ä–æ–¥–∞–∂–∞ –ø—Ä–æ–¥—É–∫—Ç–∞",
                        Amount = 1000,
                        Currency = "USD",
                        TransactionDate = DateTime.UtcNow.AddDays(-2),
                        UserId = admin.TelegramId,
                        CreatedAt = DateTime.UtcNow
                    },
                    new FinancialRecord
                    {
                        Type = FinancialRecordType.Expense,
                        Category = "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
                        Description = "–ü–æ–∫—É–ø–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
                        Amount = 500,
                        Currency = "USD",
                        TransactionDate = DateTime.UtcNow.AddDays(-1),
                        UserId = admin.TelegramId,
                        CreatedAt = DateTime.UtcNow
                    }
                };

                dbContext.FinancialRecords.AddRange(financialRecords);
                await dbContext.SaveChangesAsync();

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç
                var contact = new TeamContact
                {
                    TelegramUsername = "testcontact",
                    FullName = "–¢–µ—Å—Ç–æ–≤—ã–π –ö–æ–Ω—Ç–∞–∫—Ç",
                    ContactType = "–ö–ª–∏–µ–Ω—Ç",
                    Tags = "—Ç–µ—Å—Ç,–∫–ª–∏–µ–Ω—Ç",
                    CreatedAt = DateTime.UtcNow
                };

                dbContext.Contacts.Add(contact);
                await dbContext.SaveChangesAsync();

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
                var statusUpdate = new StatusUpdate
                {
                    ProjectId = project.Id,
                    Text = "–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ",
                    CreatedByUserId = admin.TelegramId,
                    CreatedAt = DateTime.UtcNow
                };

                dbContext.StatusUpdates.Add(statusUpdate);
                await dbContext.SaveChangesAsync();

                Console.WriteLine("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã: 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, 1 –ø—Ä–æ–µ–∫—Ç, 2 –∑–∞–¥–∞—á–∏, 2 —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏, 1 –∫–æ–Ω—Ç–∞–∫—Ç");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {ex.Message}");
                // –ù–µ –±—Ä–æ—Å–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ - –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            }
        }

        private static async Task RunBotAsync()
        {
            using var scope = _host!.Services.CreateScope();
            var botClient = scope.ServiceProvider.GetRequiredService<ITelegramBotClient>();
            var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();

            try
            {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
                var me = await botClient.GetMe(_cts.Token);

                Console.WriteLine($"ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω: @{me.Username}");
                Console.WriteLine($"üìõ –ò–º—è –±–æ—Ç–∞: {me.FirstName}");
                Console.WriteLine($"üÜî ID –±–æ—Ç–∞: {me.Id}");
                Console.WriteLine("=".PadRight(50, '='));
                Console.WriteLine("\nüì± –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –≤ Telegram\n");
                Console.WriteLine("üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:");
                Console.WriteLine("‚Ä¢ /start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞");
                Console.WriteLine("‚Ä¢ /help - –ü–æ–º–æ—â—å");
                Console.WriteLine("‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏\n");

                logger.LogInformation("Bot started: @{Username} (ID: {Id})", me.Username, me.Id);

                // –ó–∞–ø—É—Å–∫–∞–µ–º Receiver Service —á–µ—Ä–µ–∑ —Ö–æ—Å—Ç
                await _host.StartAsync(_cts.Token);

                // –ñ–¥–µ–º –æ—Ç–º–µ–Ω—ã
                await Task.Delay(Timeout.Infinite, _cts.Token);
            }
            catch (TaskCanceledException)
            {
                logger.LogInformation("Bot stopped by user request");
                Console.WriteLine("\nüëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
            }
            catch (Exception ex)
            {
                logger.LogCritical(ex, "Bot stopped with error");
                Console.WriteLine($"\n‚ùå –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å –æ—à–∏–±–∫–æ–π: {ex.Message}");
                throw;
            }
        }
    }

    // Receiver Service –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    public class ReceiverService : BackgroundService
    {
        private readonly ITelegramBotClient _botClient;
        private readonly IUpdateHandler _updateHandler;
        private readonly ILogger<ReceiverService> _logger;

        public ReceiverService(
            ITelegramBotClient botClient,
            IUpdateHandler updateHandler,
            ILogger<ReceiverService> logger)
        {
            _botClient = botClient;
            _updateHandler = updateHandler;
            _logger = logger;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            _logger.LogInformation("Starting polling...");

            var receiverOptions = new ReceiverOptions
            {
                AllowedUpdates = new[] { UpdateType.Message, UpdateType.CallbackQuery },
                DropPendingUpdates = true // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            };

            // –ó–∞–ø—É—Å–∫–∞–µ–º polling
            await _botClient.ReceiveAsync(
                updateHandler: _updateHandler,
                receiverOptions: receiverOptions,
                cancellationToken: stoppingToken);
        }

        public override async Task StopAsync(CancellationToken cancellationToken)
        {
            _logger.LogInformation("Stopping polling...");
            await base.StopAsync(cancellationToken);
        }
    }
}
